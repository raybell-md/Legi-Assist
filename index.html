<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Maryland Legi-Assist | Research & Tracking</title>
    <script 
        src="https://unpkg.com/vue@3.5.13/dist/vue.global.prod.js" 
        integrity="sha384-W/1Fp/LgAYO/oTn9Gs+PbeWuMuq1eQCnUMPCeg8POmMYchhzxctjEqtbiCIxDOON" 
        crossorigin="anonymous">
    </script>
    
    <script 
        src="https://unpkg.com/@phosphor-icons/web@2.1.2" 
        integrity="sha384-J7cw2fbG1T4C5MirTVUxsZGaMfw2m0XsCgOQEqUvB1OF9VIsHWuZF1GmyVRzs7eu" 
        crossorigin="anonymous">
    </script>
    
    <!-- Maryland Web Design System -->
    <link rel="stylesheet" href="https://cdn.maryland.gov/mdwds/0.36.0/css/mdwds.min.css" />
    <script src="https://cdn.maryland.gov/mdwds/0.36.0/js/mdwds-init.js"></script>
    <script defer src="https://cdn.maryland.gov/mdwds/0.36.0/js/mdwds-core.js"></script>

    <link rel="stylesheet" href="./assets/output_style.css">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3JEW030F57"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-3JEW030F57');
    </script>

</head>
<body class="bg-gray-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 focus:bg-white focus:text-black focus:p-4 focus:font-bold focus:rounded-lg">
        Skip to main content
    </a>
    <div id="app" v-cloak class="flex flex-col h-full font-sans text-slate-900">
        <!-- Landing View -->
        <div v-if="currentView === 'landing'" class="flex-1 overflow-y-auto bg-white flex flex-col">
            <main id="main-content" tabindex="-1">
                <div class="grid-container">
                    <div class="grid-row">
                        <div class="grid-col-12">
                            <section class="maryland-hero maryland-hero--landing-agency has-illustration has-image" aria-labelledby="hero-title" style="padding-top: 2rem; padding-bottom: 2rem; min-height: auto;">
                                <div class="maryland-hero__container">
                                    <div class="maryland-hero__row">
                                        <div class="maryland-hero__content">
                                            <h1 class="maryland-hero__title" id="hero-title">
                                                Maryland Legi-Assist
                                            </h1>

                                            <div class="maryland-hero__description">
                                                <p>Discover the legislation that matters most to you</p>
                                                
                                                <div class="bg-white p-4 mt-4 max-w-md text-left">
                                                    <label class="usa-label text-xs font-bold uppercase tracking-wide text-gray-500" for="year-select">Select Legislative Session</label>
                                                    <select class="usa-select mt-2" name="year-select" id="year-select" v-model="selectedYear" @change="fetchData">
                                                        <option v-for="year in [2026, 2025, 2024, 2023]" :value="year">{{ year }} Regular Session</option>
                                                    </select>
                                                    <button @click="enterDashboard" class="usa-button usa-button--big width-full margin-top-2 bg-red-800 hover:bg-red-900">
                                                        Search
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="maryland-hero__img-container" style="min-height: 0;">
                                            <figure class="maryland-hero__image" style="max-height: 400px; overflow: hidden; width: 100%;">
                                                <img alt="Maryland State House of Delegates Chamber" src="assets/delegates_chamber_new.jpg" style="object-fit: cover; width: 100%; height: 100%; display: block;">
                                            </figure>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>

                    <div class="grid-row margin-y-8 desktop:margin-top-10 desktop:margin-bottom-15">
                        <div class="grid-col-12 desktop:grid-col-8">
                             <div class="usa-prose">
                                <h2>Built by the Maryland State Innovation Team</h2>
                                <p class="font-sans-lg text-bold">Driving bold solutions to reduce childhood poverty and increase economic mobility.</p>
                                <p>The Innovation Team is a solution incubator, collaborating across agencies and sectors to accelerate new ways to reduce childhood poverty and improve economic mobility.</p>
                                
                                <h2>Who We Are</h2>
                                <p>We're a cross-functional team with multidisciplinary skill sets and backgrounds including:</p>
                                <ul class="usa-list list-disc pl-8">
                                    <li>Data Science</li>
                                    <li>Strategic Partnerships</li>
                                    <li>Project Management</li>
                                    <li>Community Engagement</li>
                                    <li>Civic Design</li>
                                    <li>Public Policy</li>
                                </ul>
                             </div>
                        </div>
                         <div class="grid-col-12 desktop:grid-col-4">
                             <!-- Team Image -->
                             <div class="margin-top-4 desktop:margin-top-0 height-full">
                                 <img src="./assets/retreat.jpg" alt="Maryland State Innovation Team" class="width-full height-full shadow-md" style="object-fit: cover; object-position: center;">
                             </div>
                         </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Dashboard View -->
        <div v-else class="flex h-full overflow-hidden bg-gray-50">
            <!-- Sidebar (Desktop) -->
            <aside class="display-none desktop:display-flex flex-column shrink-0 z-30 bg-white border-base-lighter border-right" style="width: 20rem;">
                <!-- Header -->
                <div class="padding-3 border-bottom border-base-lighter bg-white">
                     <a href="#" @click.prevent="currentView = 'landing'" class="display-flex flex-align-center gap-1 margin-bottom-2 no-underline text-base-darker hover:text-primary" style="text-decoration: none;" aria-label="Return to Landing Page">
                         <i class="ph ph-scroll text-primary text-xl"></i>
                         <h1 class="font-sans-md text-bold margin-0">Maryland Legi-Assist</h1>
                     </a>
                     <button @click="showAboutModal = true" class="usa-button usa-button--outline width-full display-flex flex-justify-between flex-align-center">
                         About this Tool
                     </button>
                </div>

                <!-- Filters Scroll Area -->
                <div class="flex-1 overflow-y-auto padding-3">
                     <div class="display-flex flex-justify-between flex-align-center margin-bottom-2">
                        <h2 class="font-sans-lg text-bold margin-0" style="outline: none;" ref="filtersHeading" tabindex="-1">Filters</h2>
                        <button @click="clearFilters" class="usa-button usa-button--unstyled font-sans-3xs text-uppercase text-primary hover:text-primary-dark" v-if="activeFilterCount > 0">Clear All</button>
                     </div>

                     <div class="margin-bottom-3">
                         <label class="usa-label margin-top-0" for="session-select">Session</label>
                         <select id="session-select" v-model="selectedYear" @change="fetchData" class="usa-select margin-top-1 width-full">
                             <option v-for="year in [2026, 2025, 2024, 2023]" :value="year">{{ year }} Regular Session</option>
                         </select>
                     </div>
                     
                     <hr class="border-base-lighter margin-y-3">

                    <div ref="agencyFilterContainer" class="margin-bottom-3 position-relative" @focusout="handleFocusOut('agency', $event)">
                        <label class="usa-label margin-top-0" for="agency-filter-input">Filter by Agency</label>
                        <div class="position-relative margin-top-1">
                            <input 
                                v-model="agencySearch" 
                                @focus="showAgencyList = true"
                                @input="showAgencyList = true"
                                @keydown.down.prevent="focusFirstOption"
                                @keydown.escape="showAgencyList = false"
                                type="text" 
                                id="agency-filter-input"
                                role="combobox"
                                aria-autocomplete="list"
                                aria-controls="agency-results-list"
                                :aria-expanded="showAgencyList && filteredAgencies.length > 0"
                                class="usa-input width-full"
                                style="padding-right: 2.5rem;"
                                placeholder="Search agencies..."
                            >
                            <button 
                                v-if="selectedAgency" 
                                @click="clearAgency" 
                                aria-label="Clear selected agency"
                                class="usa-button usa-button--unstyled position-absolute text-base-light hover:text-primary display-flex flex-align-center flex-justify-center"
                                style="top: 50%; right: 0.5rem; transform: translateY(-50%); width: 2rem; height: 2rem;"
                            >
                                <i class="ph-fill ph-x-circle text-xl" aria-hidden="true"></i>
                            </button>
                        </div>

                        <ul 
                            v-if="showAgencyList && filteredAgencies.length" 
                            id="agency-results-list"
                            role="listbox"
                            class="position-absolute left-0 right-0 margin-top-1 bg-white border-1px border-base-lighter shadow-2 z-50 maxh-card overflow-y-auto list-none padding-0 margin-0"
                        >
                            <li 
                                v-for="option in filteredAgencies" 
                                :key="option.name"
                                tabindex="0"
                                @click="selectAgency(option)"
                                @keydown.enter.prevent="selectAgency(option)"
                                @keydown.space.prevent="selectAgency(option)"
                                class="padding-105 hover:bg-base-lightest focus:bg-base-lightest cursor-pointer font-sans-2xs border-bottom border-base-lighter last:border-0 text-base-darker outline-none focus:outline-primary"
                            >
                                {{ option.displayName }}
                            </li>
                        </ul>

                        <div v-if="selectedAgency" class="margin-top-2 padding-2 bg-primary-lighter radius-md border border-primary-light">
                            <label class="usa-label margin-top-0 text-primary-darker font-sans-3xs uppercase" for="agency-relevance-select">Relevance Threshold</label>
                            <select id="agency-relevance-select" v-model="filterRating" class="usa-select margin-top-05 height-auto py-1 font-sans-2xs">
                                <option value="all">All Relevance Levels</option>
                                <option value="5">Primary - 5</option>
                                <option value="4">High - 4+</option>
                                <option value="3">Moderate - 3+</option>
                                <option value="2">Low - 2+</option>
                            </select>
                        </div>
                    </div>

                    <hr class="border-base-lighter margin-y-3">

                    <div ref="sponsorFilterContainer" class="margin-bottom-3 position-relative" @focusout="handleFocusOut('sponsor', $event)">
                        <label class="usa-label margin-top-0" for="sponsor-filter-input">Filter by Sponsor</label>
                        <div class="position-relative margin-top-1">
                            <input 
                                v-model="sponsorSearch" 
                                @focus="showSponsorList = true"
                                @input="showSponsorList = true"
                                @keydown.escape="showSponsorList = false"
                                type="text" 
                                id="sponsor-filter-input"
                                role="combobox"
                                aria-autocomplete="list"
                                aria-controls="sponsor-results-list"
                                :aria-expanded="showSponsorList && filteredSponsors.length > 0"
                                class="usa-input width-full"
                                style="padding-right: 2.5rem;"
                                placeholder="Search sponsors..."
                            >
                            <button 
                                v-if="selectedSponsor" 
                                @click="clearSponsor" 
                                aria-label="Clear selected sponsor"
                                class="usa-button usa-button--unstyled position-absolute text-base-light hover:text-primary display-flex flex-align-center flex-justify-center"
                                style="top: 50%; right: 0.5rem; transform: translateY(-50%); width: 2rem; height: 2rem;"
                            >
                                <i class="ph-fill ph-x-circle text-xl" aria-hidden="true"></i>
                            </button>
                        </div>

                        <ul 
                            v-if="showSponsorList && filteredSponsors.length" 
                            id="sponsor-results-list"
                            role="listbox"
                            class="position-absolute left-0 right-0 margin-top-1 bg-white border-1px border-base-lighter shadow-2 z-50 maxh-card overflow-y-auto list-none padding-0 margin-0"
                        >
                            <li 
                                v-for="option in filteredSponsors" 
                                :key="option"
                                tabindex="0"
                                @click="selectSponsor(option)"
                                @keydown.enter.prevent="selectSponsor(option)"
                                @keydown.space.prevent="selectSponsor(option)"
                                class="padding-105 hover:bg-base-lightest focus:bg-base-lightest cursor-pointer font-sans-2xs border-bottom border-base-lighter last:border-0 text-base-darker outline-none focus:outline-primary"
                            >
                                {{ option }}
                            </li>
                        </ul>
                    </div>

                     <hr class="border-base-lighter margin-y-3">

                     <div class="margin-bottom-3">
                        <label class="usa-label margin-top-0" for="keyword-search">Keyword Search</label>
                        <input v-model="searchQuery" id="keyword-search" type="text" class="usa-input margin-top-0 width-full" placeholder="Title, summary, ID...">
                     </div>

                     <fieldset class="usa-fieldset margin-bottom-3">
                        <legend class="usa-label margin-top-0 margin-bottom-1">Broad Subjects</legend>
                        <input 
                            v-model="broadSubjectSearch" 
                            type="text" 
                            class="usa-input margin-bottom-1 height-4 font-sans-2xs" 
                            placeholder="Filter broad subjects..." 
                            aria-label="Filter Broad Subjects"
                        >
                        <div class="border-1px border-base-lighter padding-1 overflow-y-auto bg-white" style="max-height: 10rem;">
                            <div class="usa-checkbox" v-for="sub in filteredBroadSubjects" :key="sub.Code">
                                <input class="usa-checkbox__input" :id="'broad-'+sub.Code" type="checkbox" v-model="filterBroad" :value="sub.Name" @focus="scrollToFocusedItem">
                                <label class="usa-checkbox__label" :for="'broad-'+sub.Code">{{ sub.Name }}</label>
                            </div>
                            <div v-if="filteredBroadSubjects.length === 0" class="font-sans-2xs text-base-light text-italic padding-1">
                                No matches found
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="usa-fieldset">
                        <legend class="usa-label margin-top-0 margin-bottom-1">Narrow Subjects</legend>
                        <input 
                            v-model="narrowSubjectSearch" 
                            type="text" 
                            class="usa-input margin-bottom-1 height-4 font-sans-2xs" 
                            placeholder="Filter narrow subjects..." 
                            aria-label="Filter Narrow Subjects"
                        >
                        <div class="border-1px border-base-lighter padding-1 overflow-y-auto bg-white" style="max-height: 10rem;">
                            <div class="usa-checkbox" v-for="sub in filteredNarrowSubjects" :key="sub.Code">
                                <input class="usa-checkbox__input" :id="'narrow-'+sub.Code" type="checkbox" v-model="filterNarrow" :value="sub.Name" @focus="scrollToFocusedItem">
                                <label class="usa-checkbox__label" :for="'narrow-'+sub.Code">{{ sub.Name }}</label>
                            </div>
                            <div v-if="filteredNarrowSubjects.length === 0" class="font-sans-2xs text-base-light text-italic padding-1">
                                No matches found
                            </div>
                        </div>
                    </fieldset>

                    <hr class="border-base-lighter margin-y-3">

                    <div class="padding-2 bg-base-lightest radius-md border border-base-lighter">
                         <div class="display-flex flex-align-center gap-1 margin-bottom-1">
                             <span class="font-sans-xs text-bold text-base-darker leading-tight">Built by the Maryland State Innovation Team</span>
                         </div>
                         <a href="https://innovation.maryland.gov" target="_blank" class="font-sans-xs text-primary hover:text-primary-dark text-bold display-flex flex-align-center gap-1 margin-top-1">
                             Learn more at innovation.maryland.gov
                             <i class="ph ph-arrow-square-out" aria-hidden="true"></i>
                         </a>
                    </div>
                </div>
            </aside>

            <!-- Main Results Area -->
            <main id="main-content" class="flex-1 display-flex flex-column min-w-0 bg-white position-relative">
                 <!-- Mobile Header -->
                 <div class="display-flex desktop:display-none bg-white border-bottom border-base-lighter padding-2 flex-align-center width-full z-10 sticky top-0">
                     <a href="#" @click.prevent="currentView = 'landing'" class="display-flex flex-align-center gap-1 no-underline text-base-darker hover:text-primary" style="text-decoration: none;" aria-label="Return to Landing Page">
                         <i class="ph ph-scroll text-xl text-primary"></i>
                         <span class="font-sans-md text-bold">MD Legi-Assist</span>
                     </a>
                     <div class="display-flex flex-align-center gap-1 margin-left-auto">
                        <button 
                            @click="showAboutModal = true" 
                            class="usa-button usa-button--unstyled display-flex flex-align-center flex-justify-center width-4 height-4 text-base-darker hover:text-primary radius-pill hover:bg-base-lightest transition-colors"
                            aria-label="About this Tool"
                        >
                            <i class="ph ph-info text-xl"></i>
                        </button>

                        <button 
                            @click="exportToExcel" 
                            class="usa-button usa-button--unstyled display-flex flex-align-center flex-justify-center width-4 height-4 text-base-darker hover:text-primary radius-pill hover:bg-base-lightest transition-colors"
                            aria-label="Export Results to CSV"
                        >
                            <i class="ph ph-download-simple text-xl"></i>
                        </button>

                        <button @click="showFilterDrawer = true" class="usa-button usa-button--outline usa-button--small display-flex flex-align-center gap-1 margin-right-0 margin-left-1">
                            <i class="ph ph-funnel text-lg"></i>
                            Filters
                            <span v-if="activeFilterCount > 0" class="display-inline-block width-2 height-2 bg-primary text-white radius-pill text-center text-bold font-sans-3xs leading-none flex flex-align-center flex-justify-center" style="line-height: 1;">{{ activeFilterCount }}</span>
                        </button>
                    </div>
                 </div>
                 
                 <!-- Results Header (Desktop) -->
                <div class="display-none desktop:display-flex flex-justify-between flex-align-center padding-x-3 padding-top-5 padding-bottom-6 bg-white border-bottom border-base-lighter shrink-0 width-full">
                    <div
                        class="maryland-listing__list-summary flex-1"
                        role="status"
                        aria-live="polite"
                        aria-atomic="true"
                    >
                        <p class="margin-0 font-sans-lg">
                            <strong>{{ filteredBills.length }}</strong> Results
                            <span v-if="selectedAgency" class="text-primary text-bold margin-left-1">for {{ selectedAgency }}</span>
                        </p>
                    </div>

                     <div class="display-flex flex-align-center gap-2">
                         <div v-if="selectedYear === 2026 || selectedAgency" class="display-flex flex-align-center">
                            <label for="sort-select" class="usa-label margin-0 margin-right-1 font-sans-xs text-base-dark text-bold text-no-wrap">Sort by</label>
                            <select 
                                id="sort-select" 
                                v-model="sortBy" 
                                class="usa-select margin-0 width-auto font-sans-xs bg-white border-base-light"
                                style="height: 2.5rem; padding-top: 0.5rem; padding-bottom: 0.5rem;"
                            >
                                <option v-if="selectedYear === 2026" value="date">Newest First</option>
                                <option v-if="selectedYear === 2026" value="upcoming">Upcoming Action</option>
                                <option v-if="selectedAgency" value="relevance">Highest Relevance</option>
                                <option value="bill_number">Bill Number</option>
                            </select>
                        </div>
                        <button 
                            @click="exportToExcel" 
                            class="usa-button usa-button--outline bg-white hover:bg-base-lightest display-flex flex-align-center gap-1 margin-0"
                            style="height: 2.5rem;"
                        >
                            <i class="ph ph-download-simple text-lg text-primary"></i> Export CSV
                        </button>
                     </div>
                 </div>

                 <!-- Scrollable Results -->
                 <section class="flex-1 overflow-y-auto padding-2 desktop:padding-4 scroll-smooth bg-base-lightest">
                     <div v-if="loading" class="display-flex flex-column flex-align-center flex-justify-center text-base-light" style="height: 16rem;">
                         <div class="width-6 height-6 radius-pill border-2px border-top-primary margin-bottom-2" style="border-right-color: transparent; border-bottom-color: transparent; border-left-color: transparent; animation: spin 1s linear infinite;"></div>
                         <p class="font-sans-lg text-bold">Syncing Legislative Data...</p>
                     </div>
                     <style>
                        @keyframes spin { 100% { transform: rotate(360deg); } }
                     </style>

                     <div v-else class="grid-container padding-0 desktop:padding-x-4 width-full">

                        <div class="desktop:display-none padding-bottom-2 margin-bottom-2 border-bottom border-base-lighter text-center" role="status" aria-live="polite">
                            <span class="font-sans-xs text-base-default text-italic">{{ filteredBills.length }} Results</span>
                        </div>

                        <ul class="maryland-card-group">
                            <li v-for="(bill, index) in filteredBills" :key="bill.BillNumber" class="maryland-card maryland-card--flag width-full margin-bottom-2 border-0">
                                <div 
                                    class="maryland-card__container cursor-pointer shadow-1 hover:shadow-3 transition-shadow bg-white"
                                    @click="openBill(bill)"
                                    @keydown.enter.prevent="openBill(bill)"
                                    @keydown.space.prevent="openBill(bill)"
                                    tabindex="0"
                                    role="button"
                                    :aria-label="'View details for ' + bill.BillNumber"
                                >
                                    <div class="display-flex flex-column flex-1 padding-3">
                                        <div class="maryland-card__header padding-0 margin-bottom-1">

                                            <div class="margin-bottom-05">
                                                <h2 class="font-sans-xl text-bold text-primary line-height-sans-2 margin-0">
                                                    {{ bill.BillNumber }}{{ bill.CrossfileBillNumber ? ' / ' + bill.CrossfileBillNumber : '' }}
                                                </h2>
                                            </div>

                                            <div class="display-flex flex-wrap flex-align-center gap-1 margin-bottom-1">
                                                <span v-if="getRelevance(bill)" class="usa-tag bg-primary-lighter text-primary-darker font-sans-2xs text-bold">
                                                    Relevance: {{ getRelevance(bill).relevance_rating }}/5
                                                </span>

                                                <span v-if="isNew(bill.first_seen)" class="usa-tag bg-accent-cool text-white font-sans-2xs text-bold">New</span>
                                            </div>

                                            <h3 class="maryland-card__heading font-sans-lg text-bold text-base-darker line-height-sans-3 margin-0">
                                                {{ bill.Title }}
                                            </h3>
                                        </div>

                                        <div class="maryland-card__body padding-0 flex-1">
                                            <div v-if="selectedYear === 2026 && getNextAction(bill)" class="margin-bottom-2">
                                                <span class="inline-flex flex-align-center gap-1 bg-accent-warm-lighter text-base-darker padding-x-105 padding-y-05 radius-md font-sans-xs text-bold border border-accent-warm-light">
                                                    <i class="ph ph-calendar-blank text-lg"></i>
                                                    {{ getNextAction(bill).label }}: {{ formatDate(getNextAction(bill).date) }} 
                                                    <span v-if="getNextAction(bill).isTime" class="text-normal margin-left-05">{{ formatTime(getNextAction(bill).date) }}</span>
                                                </span>
                                            </div>

                                            <p class="font-sans-md text-base-dark line-clamp-3 margin-0">
                                                {{ bill.bill_summary }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                         
                         <div v-if="filteredBills.length === 0" class="text-center padding-y-8 bg-white radius-lg border-1px border-base-lighter border-dashed margin-top-4">
                             <i class="ph ph-files text-huge text-base-lighter margin-bottom-1"></i>
                             <p class="text-base-light font-medium margin-bottom-2">No bills match your criteria.</p>
                             <button @click="clearFilters" class="usa-button usa-button--unstyled text-primary text-bold">Clear Filters</button>
                         </div>
                     </div>
                 </section>
            </main>
            
            <!-- Mobile Drawer Reuse (Hidden by default) -->
            <transition name="fade">
                <div v-if="showFilterDrawer" class="position-fixed inset-0 z-50 drawer-overlay desktop:display-none" @click.self="showFilterDrawer = false">
                    <aside ref="filterDrawer" role="dialog" aria-modal="true" aria-labelledby="drawer-title" @keydown="trapFocusDrawer" class="position-absolute inset-y-0 left-0 width-full bg-white shadow-3 display-flex flex-column" style="width: 85vw; max-width: 20rem;">
                        <div class="padding-2 border-bottom border-base-lighter flex justify-between items-center bg-base-lightest w-full">
                            <div class="flex items-center gap-2">
                                <h2 id="drawer-title" ref="mobileFiltersHeading" tabindex="-1" class="font-bold text-lg text-base-dark margin-0" style="outline: none;">Filters</h2>
                                <button @click="clearFilters" class="usa-button usa-button--unstyled font-sans-3xs text-uppercase text-primary hover:text-primary-dark" v-if="activeFilterCount > 0">Clear All</button>
                            </div>
                            <button @click="showFilterDrawer = false" aria-label="Close filters" class="usa-button usa-button--unstyled text-base-dark hover:text-primary margin-0"><i class="ph ph-x text-xl" aria-hidden="true"></i></button>
                        </div>
                        <div class="padding-2 flex-1 overflow-y-auto">
                            <div v-if="selectedYear === 2026 || selectedAgency" class="margin-bottom-3">
                                <label class="usa-label margin-top-0" for="drawer-sort">Sort Order</label>
                                <select v-model="sortBy" id="drawer-sort" class="usa-select width-full">
                                    <option v-if="selectedYear === 2026" value="date">Newest First</option>
                                    <option v-if="selectedYear === 2026" value="upcoming">Upcoming Action</option>
                                    <option v-if="selectedAgency" value="relevance">Highest Relevance</option>
                                    <option value="bill_number">Bill Number</option>
                                </select>
                            </div>

                        <hr v-if="selectedYear === 2026 || selectedAgency" class="border-base-lighter margin-y-3">
                            <div class="margin-bottom-3">
                                 <label class="usa-label margin-top-0" for="mobile-year-select">Session</label>
                                 <select v-model="selectedYear" id="mobile-year-select" @change="fetchData" class="usa-select width-full">
                                     <option v-for="year in [2026, 2025, 2024, 2023]" :value="year">{{ year }}</option>
                                 </select>
                            </div>
                            
                            <div class="margin-bottom-3" @focusout="handleFocusOut('agency', $event)">
                                <label class="usa-label margin-top-0" for="mobile-agency-input">Filter by Agency</label>
                                <input 
                                    v-model="agencySearch" 
                                    @focus="showAgencyList = true"
                                    @input="showAgencyList = true"
                                    @keydown.escape="showAgencyList = false"
                                    type="text"
                                    id="mobile-agency-input"
                                    role="combobox"
                                    aria-autocomplete="list"
                                    aria-controls="mobile-agency-results-list"
                                    :aria-expanded="showAgencyList && filteredAgencies.length > 0" 
                                    placeholder="Search agencies..." 
                                    class="usa-input width-full margin-bottom-1"
                                >

                                <div v-if="selectedAgency" class="padding-1 bg-primary-lighter text-primary-darker radius-md border-1px border-primary-light margin-bottom-1">
                                    <div class="display-flex flex-align-center flex-justify-between font-sans-2xs text-bold margin-bottom-1">
                                        {{ agencySearch }}
                                        <button @click="clearAgency" aria-label="Clear selected agency" class="usa-button usa-button--unstyled text-primary"><i class="ph ph-x-circle text-lg" aria-hidden="true"></i></button>
                                    </div>

                                    <label class="usa-label margin-top-0 text-primary-darker font-sans-3xs uppercase" for="mobile-relevance-select">Relevance Threshold</label>
                                    <select v-model="filterRating" id="mobile-relevance-select" class="usa-select margin-top-05 height-auto py-1 font-sans-2xs width-full bg-white">
                                        <option value="all">All Relevance Levels</option>
                                        <option value="5">Primary - 5</option>
                                        <option value="4">High - 4+</option>
                                        <option value="3">Moderate - 3+</option>
                                        <option value="2">Low - 2+</option>
                                    </select>
                                </div>

                                <div 
                                    v-if="showAgencyList && filteredAgencies.length" 
                                    id="mobile-agency-results-list"
                                    role="listbox"
                                    class="border-1px border-base-lighter radius-md overflow-y-auto" 
                                    style="max-height: 10rem;"
                                >
                                    <div 
                                        v-for="option in filteredAgencies" 
                                        :key="option.name"
                                        tabindex="0"
                                        @click="selectAgency(option)"
                                        @keydown.enter.prevent="selectAgency(option)"
                                        @keydown.space.prevent="selectAgency(option)"
                                        class="padding-1 border-bottom border-base-lighter hover:bg-base-lightest focus:bg-base-lightest font-sans-2xs text-base-dark last:border-0 outline-none focus:outline-primary cursor-pointer"
                                    >
                                        {{ option.displayName }}
                                    </div>
                                </div>
                            </div>
                            
                            <hr class="border-base-lighter margin-y-2">
                            
                            <div class="margin-bottom-3" @focusout="handleFocusOut('sponsor', $event)">
                                <label class="usa-label margin-top-0" for="mobile-sponsor-input">Filter by Sponsor</label>
                                <input 
                                    v-model="sponsorSearch" 
                                    @focus="showSponsorList = true"
                                    @input="showSponsorList = true"
                                    @keydown.escape="showSponsorList = false"
                                    type="text" 
                                    id="mobile-sponsor-input"
                                    role="combobox"
                                    aria-autocomplete="list"
                                    aria-controls="mobile-sponsor-results-list"
                                    :aria-expanded="showSponsorList && filteredSponsors.length > 0"
                                    placeholder="Search sponsors..." 
                                    class="usa-input width-full margin-bottom-1"
                                >

                                <div v-if="selectedSponsor" class="display-flex flex-align-center flex-justify-between padding-1 bg-primary-lighter text-primary-darker radius-md font-sans-2xs text-bold border-1px border-primary-light margin-bottom-1">
                                    {{ sponsorSearch }}
                                    <button @click="clearSponsor" aria-label="Clear selected sponsor" class="usa-button usa-button--unstyled text-primary"><i class="ph ph-x-circle text-lg" aria-hidden="true"></i></button>
                                </div>

                                <div 
                                    v-if="showSponsorList && filteredSponsors.length" 
                                    id="mobile-sponsor-results-list"
                                    role="listbox"
                                    class="border-1px border-base-lighter radius-md overflow-y-auto" 
                                    style="max-height: 10rem;"
                                >
                                    <div 
                                        v-for="option in filteredSponsors" 
                                        :key="option"
                                        tabindex="0"
                                        @click="selectSponsor(option)"
                                        @keydown.enter.prevent="selectSponsor(option)"
                                        @keydown.space.prevent="selectSponsor(option)"
                                        class="padding-1 border-bottom border-base-lighter hover:bg-base-lightest focus:bg-base-lightest font-sans-2xs text-base-dark last:border-0 outline-none focus:outline-primary cursor-pointer"
                                    >
                                        {{ option }}
                                    </div>
                                </div>
                            </div>

                            <hr class="border-base-lighter margin-y-2">

                            <div class="margin-bottom-3">
                                <label class="usa-label margin-top-0" for="mobile-keyword-input">Keyword Search</label>
                                <input v-model="searchQuery" id="mobile-keyword-input" type="text" class="usa-input width-full" placeholder="Title, summary, ID...">
                            </div>
                            
                             <fieldset class="usa-fieldset margin-bottom-3">
                                <legend class="usa-label margin-top-0 margin-bottom-1">Broad Subjects</legend>
                                <input 
                                    v-model="broadSubjectSearch" 
                                    type="text" 
                                    class="usa-input margin-bottom-1 height-4 font-sans-2xs width-full" 
                                    placeholder="Filter broad subjects..." 
                                    aria-label="Filter Broad Subjects"
                                >
                                <div class="border-1px border-base-lighter padding-1 overflow-y-auto bg-white margin-top-1" style="max-height: 10rem;">
                                    <div class="usa-checkbox" v-for="sub in filteredBroadSubjects" :key="sub.Code">
                                        <input class="usa-checkbox__input" :id="'mobile-broad-'+sub.Code" type="checkbox" v-model="filterBroad" :value="sub.Name" @focus="scrollToFocusedItem">
                                        <label class="usa-checkbox__label" :for="'mobile-broad-'+sub.Code">{{ sub.Name }}</label>
                                    </div>
                                    <div v-if="filteredBroadSubjects.length === 0" class="font-sans-2xs text-base-light text-italic padding-1">
                                        No matches found
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset class="usa-fieldset">
                                <legend class="usa-label margin-top-0 margin-bottom-1">Narrow Subjects</legend>
                                <input 
                                    v-model="narrowSubjectSearch" 
                                    type="text" 
                                    class="usa-input margin-bottom-1 height-4 font-sans-2xs width-full" 
                                    placeholder="Filter narrow subjects..." 
                                    aria-label="Filter Narrow Subjects"
                                >
                                <div class="border-1px border-base-lighter padding-1 overflow-y-auto bg-white margin-top-1" style="max-height: 10rem;">
                                    <div class="usa-checkbox" v-for="sub in filteredNarrowSubjects" :key="sub.Code">
                                        <input class="usa-checkbox__input" :id="'mobile-narrow-'+sub.Code" type="checkbox" v-model="filterNarrow" :value="sub.Name" @focus="scrollToFocusedItem">
                                        <label class="usa-checkbox__label" :for="'mobile-narrow-'+sub.Code">{{ sub.Name }}</label>
                                    </div>
                                    <div v-if="filteredNarrowSubjects.length === 0" class="font-sans-2xs text-base-light text-italic padding-1">
                                        No matches found
                                    </div>
                                </div>
                            </fieldset>

                            <hr class="border-base-lighter margin-y-3">

                            <div class="padding-2 bg-base-lightest radius-md border border-base-lighter">
                                 <div class="display-flex flex-align-center gap-1 margin-bottom-1">
                                     <div class="width-4 height-4 bg-black circle display-flex flex-justify-center flex-align-center text-white font-sans-3xs text-bold shrink-0">IT</div>
                                     <span class="font-sans-xs text-bold text-base-darker leading-tight">Maryland State<br>Innovation Team</span>
                                 </div>
                                 <a href="https://innovation.maryland.gov" target="_blank" class="font-sans-xs text-primary hover:text-primary-dark text-bold display-flex flex-align-center gap-1 margin-top-1">
                                     Learn more at innovation.maryland.gov
                                     <i class="ph ph-arrow-square-out" aria-hidden="true"></i>
                                 </a>
                            </div>
                        </div>
                        <div class="padding-2 border-top border-base-lighter">
                            <button @click="showFilterDrawer = false" class="usa-button width-full">Show {{ filteredBills.length }} Results</button>
                        </div>
                    </aside>
                </div>
            </transition>
        </div>

        <!-- Bill Detail Modal -->
        <transition name="fade">
            <div 
                v-if="activeBill" 
                role="dialog" 
                aria-modal="true" 
                aria-labelledby="modal-title"
                class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4 bg-black/60 backdrop-blur-sm" 
                @click.self="closeBill"
                @keydown.esc="closeBill"
                @keydown.tab="trapFocus"
            >
                <div class="bg-white shadow-3 w-full sm:max-w-5xl max-h-[85dvh] sm:max-h-[90vh] flex flex-col overflow-hidden">
                    <header class="p-4 sm:p-6 border-b border-base-lighter bg-white flex justify-between items-start gap-3 shrink-0">
                        <div class="min-w-0 flex-1">
                            <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-1">
                                <h2 id="modal-title" ref="modalTitle" tabindex="-1" class="font-sans-xl desktop:font-sans-2xl text-bold text-primary outline-none line-height-sans-2">
                                    {{ activeBill.BillNumber }}{{ activeBill.CrossfileBillNumber ? ' / ' + activeBill.CrossfileBillNumber : '' }}
                                </h2>
                                <span class="px-2 sm:px-3 py-05 bg-white border border-base-light font-sans-3xs text-bold text-base-dark uppercase tracking-wider">{{ activeBill.YearAndSession }}</span>
                            </div>
                        </div>
                        <button @click="closeBill" aria-label="Close Modal" class="usa-button usa-button--unstyled p-2 hover:bg-base-lightest transition-colors shrink-0 text-base-darker">
                            <i class="ph ph-x text-2xl" aria-hidden="true"></i>
                        </button>
                    </header>

                    <div class="flex-1 overflow-y-auto min-h-0 p-4 sm:p-6 md:p-10 pb-[max(2rem,env(safe-area-inset-bottom))]">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-10">
                            <div class="lg:col-span-2 space-y-6 sm:space-y-8">
                                <h3 class="font-sans-lg text-bold text-base-darker line-height-sans-3">{{ activeBill.Title }}</h3>
                                <section v-if="getRelevance(activeBill)" aria-labelledby="relevance-heading" class="bg-primary-lighter border-l-4 border-primary p-4 sm:p-6">
                                    <h4 id="relevance-heading" class="text-primary-darker font-bold uppercase font-sans-3xs tracking-widest mb-2">Agency Relevance: {{ selectedAgency }}</h4>
                                    <p class="text-base-darker font-medium leading-relaxed font-sans-md">{{ getRelevance(activeBill).relevance_explanation }}</p>
                                </section>

                                <section aria-labelledby="summary-heading">
                                    <h4 id="summary-heading" class="text-base-dark font-bold uppercase font-sans-3xs tracking-widest mb-3">Plain-English Summary</h4>
                                    <p class="text-base-darker leading-relaxed font-sans-md">{{ activeBill.bill_summary }}</p>
                                </section>

                                <section v-if="activeBill.fiscal_impact_summary" aria-labelledby="fiscal-heading">
                                    <h4 id="fiscal-heading" class="text-base-dark font-bold uppercase font-sans-3xs tracking-widest mb-3">Fiscal Impact Analysis</h4>
                                    <div class="bg-accent-cool-lighter text-base-darker p-4 sm:p-5 border border-accent-cool-light font-sans-md">
                                        <div v-if="activeBill.has_fiscal_note === false" class="flex items-start gap-2 mb-3 pb-3 border-b border-accent-cool-light">
                                            <i class="ph ph-warning text-lg text-accent-cool-dark mt-0.5 shrink-0"></i>
                                            <p class="text-base-darker font-medium italic font-sans-xs">
                                                Disclaimer: This fiscal analysis is preliminary and may change when the fiscal and policy note incorporating agency and DLS feedback is published.
                                            </p>
                                        </div>
                                        {{ activeBill.fiscal_impact_summary }}
                                    </div>
                                </section>

                                <div v-if="activeBill.responsible_party || activeBill.stakeholders" class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                                    <div v-if="activeBill.responsible_party" class="p-4 bg-base-lightest border border-base-lighter">
                                        <h5 class="font-sans-3xs font-bold text-base-dark uppercase mb-2">Responsible Party</h5>
                                        <p class="font-bold text-base-darker font-sans-sm">{{ activeBill.responsible_party }}</p>
                                    </div>
                                    <div v-if="activeBill.stakeholders" class="p-4 bg-base-lightest border border-base-lighter">
                                        <h5 class="font-sans-3xs font-bold text-base-dark uppercase mb-2">Stakeholders</h5>
                                        <p class="font-sans-xs text-base-dark">{{ activeBill.stakeholders }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <dl class="bg-base-lightest border border-base-lighter p-4 sm:p-5 space-y-4">
                                    <div>
                                        <dt class="font-sans-3xs font-bold text-base-dark uppercase tracking-wide">Primary Sponsor</dt>
                                        <dd class="font-sans-sm font-bold text-base-darker mt-1">{{ activeBill.SponsorPrimary }}</dd>
                                    </div>
                                    <div>
                                        <dt class="font-sans-3xs font-bold text-base-dark uppercase tracking-wide">Current Status</dt>
                                        <dd class="font-sans-sm font-bold text-primary mt-1">{{ activeBill.Status }}</dd>
                                    </div>

                                    <div v-if="getNextAction(activeBill)?.label === 'Hearing' && getTestimonyDeadline(getNextAction(activeBill).date)">
                                        <dt class="font-sans-3xs font-bold text-base-dark uppercase tracking-wide">Testimony Deadline</dt>
                                        <dd class="font-sans-sm font-bold text-red-800 mt-1">
                                            {{ formatDate(getTestimonyDeadline(getNextAction(activeBill).date)) }} @ 6:00 PM
                                        </dd>
                                    </div>

                                    <div v-if="activeBill.funding != null">
                                        <dt class="font-sans-3xs font-bold text-base-dark uppercase tracking-wide">Est. Funding Impact</dt>
                                        <dd class="font-sans-sm font-bold text-accent-cool-darker mt-1">{{ formatCurrency(activeBill.funding) }}</dd>
                                    </div>
                                    
                                    <div v-if="(activeBill.first_seen || activeBill.last_updated) && selectedYear >= 2026" class="pt-4 mt-4 border-t border-base-light grid grid-cols-2 gap-4">
                                        <div v-if="activeBill.first_seen">
                                            <dt class="font-sans-3xs font-bold text-base-dark uppercase tracking-wide">First Seen</dt>
                                            <dd class="font-sans-sm font-medium text-base-darker mt-1">{{ formatTimestamp(activeBill.first_seen) }}</dd>
                                        </div>
                                        <div v-if="activeBill.last_updated">
                                            <dt class="font-sans-3xs font-bold text-base-dark uppercase tracking-wide">Last Updated</dt>
                                            <dd class="font-sans-sm font-medium text-base-darker mt-1">{{ formatTimestamp(activeBill.last_updated) }}</dd>
                                        </div>
                                    </div>
                                </dl>

                                <div>
                                    <h4 class="font-sans-3xs font-bold text-base-dark uppercase mb-2">Subjects</h4>
                                    <ul class="flex flex-wrap gap-2" aria-label="Bill subjects">
                                        <li v-for="s in activeBill.BroadSubjects" class="px-2 py-05 bg-base-lightest text-base-darker border border-base-lighter font-sans-3xs font-bold uppercase">{{ s.Name }}</li>
                                        <li v-for="s in activeBill.NarrowSubjects" class="px-2 py-05 bg-accent-cool-lighter text-accent-cool-darker border border-accent-cool-light font-sans-3xs text-bold">{{ s.Name }}</li>
                                    </ul>
                                </div>

                                <a :href="'https://mgaleg.maryland.gov/mgawebsite/Legislation/Details/' + activeBill.BillNumber + '?ys=' + selectedYear + 'RS'" 
                                target="_blank"
                                rel="noopener"
                                class="usa-button usa-button--primary width-full display-flex flex-justify-center flex-align-center gap-1 margin-0 text-no-underline hover:text-white">
                                    View Bill on MGA
                                    <i class="ph ph-arrow-square-out" aria-hidden="true"></i>
                                    <span class="sr-only">(opens in new tab)</span>
                                </a>
                            </div>
                        </div>

                        <div class="mt-6 sm:mt-10 pt-4 sm:pt-6 border-t border-base-lighter">
                            <div class="flex flex-col sm:flex-row gap-3 items-start bg-base-lightest p-4 border border-base-lighter text-base-dark">
                                <i class="ph ph-robot text-xl shrink-0 mt-0.5 text-base-light" aria-hidden="true"></i>
                                <div class="font-sans-xs font-medium leading-relaxed">
                                    <strong class="block mb-1 text-base-darker uppercase tracking-wide">Automated Summary Disclaimer</strong>
                                    <p>
                                        The summary content, relevance ratings, and fiscal analysis displayed here were generated using AI and may contain inaccuracies. 
                                        This tool is for research assistance only. Please verify all details directly against the official 
                                        <a :href="'https://mgaleg.maryland.gov/mgawebsite/Legislation/Details/' + activeBill.BillNumber + '?ys=' + selectedYear + 'RS'" target="_blank" rel="noopener" class="usa-link text-bold">
                                            Maryland General Assembly website
                                            <span class="sr-only">(opens in new tab)</span>
                                        </a>.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- About Modal -->
        <transition name="fade">
            <div 
                v-if="showAboutModal" 
                role="dialog" 
                aria-modal="true" 
                aria-labelledby="about-modal-title"
                class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4 bg-slate-900/60 backdrop-blur-sm" 
                @click.self="showAboutModal = false"
                @keydown.esc="showAboutModal = false"
                @keydown.tab="trapFocus"
            >
                <div class="bg-white shadow-2xl w-full sm:max-w-2xl max-h-[85dvh] sm:max-h-[90vh] flex flex-col overflow-hidden">
                    <header class="p-4 sm:p-6 border-b border-gray-200 bg-white flex justify-between items-center shrink-0">
                        <h2 id="about-modal-title" ref="modalTitle" tabindex="-1" class="text-lg sm:text-xl font-bold text-base-darker outline-none">
                            About Maryland Legi-Assist
                        </h2>
                        <button @click="showAboutModal = false" aria-label="Close Modal" class="p-2 hover:bg-gray-100 transition-colors">
                            <i class="ph ph-x text-2xl text-base-darker" aria-hidden="true"></i>
                        </button>
                    </header>
                    <div class="p-6 sm:p-8 space-y-6 overflow-y-auto min-h-0 pb-[max(2rem,env(safe-area-inset-bottom))]">
                        <section>
                            <h3 class="font-bold text-base-darker mb-4 text-lg">Methodology</h3>
                            <ul class="space-y-3 text-base-dark leading-relaxed text-sm sm:text-base list-disc pl-5 marker:text-red-800">
                                <li>Every night at midnight, the tool connects to the MGA website to download new data about bills in the current legislative session.</li>
                                <li>The latest bill texts, adopted amendments, and fiscal notes are downloaded and saved.</li>
                                <li>The tool then enhances the existing MGA data with AI-generated responses driven by the full bill text and fiscal note, such as plain language summaries, summarized fiscal impacts, responsible parties, and stakeholder analysis.</li>
                                <li>The tool also maintains descriptions of 120 agencies and state entities, and rates the relevance of each introduced bill against a Google-search grounded description of the agency.</li>
                                <li>This allows agency users to quickly identify which newly introduced bills are most relevant to their work, see upcoming hearing dates, and export the data to bring into their legislative processes.</li>
                            </ul>
                        </section>
                    </div>
                    <footer class="p-4 sm:p-6 bg-white border-t border-gray-200 flex justify-between items-center shrink-0">
                        <a href="https://github.com/Maryland-State-Innovation-Team/Legi-Assist/" 
                        target="_blank" 
                        rel="noopener" 
                        class="usa-button usa-button--outline m-0 flex items-center justify-center gap-2 h-10 px-4 no-underline text-base-darker hover:text-primary">
                            <i class="ph ph-github-logo text-lg" aria-hidden="true"></i> 
                            View on GitHub
                            <span class="sr-only">(opens in new tab)</span>
                        </a>
                        <button @click="showAboutModal = false" class="usa-button usa-button--primary m-0 flex items-center justify-center h-10 px-6">
                            Got it
                        </button>
                    </footer>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const currentView = ref('landing');
                const agenciesData = ref({});
                const allBills = ref([]);
                const loading = ref(true);
                const selectedYear = ref(2026);
                const searchQuery = ref("");
                const agencySearch = ref("");
                const selectedAgency = ref("");
                const showAgencyList = ref(false);
                const sponsorSearch = ref("");
                const selectedSponsor = ref("");
                const broadSubjectSearch = ref("");
                const narrowSubjectSearch = ref("");
                const showSponsorList = ref(false);
                const filterBroad = ref([]);
                const filterNarrow = ref([]);
                const filterRating = ref("all");
                const sortBy = ref("date");
                const activeBill = ref(null);
                const pendingBillId = ref(null);
                const showAboutModal = ref(false);
                const showFilterDrawer = ref(false);
                const drawerReady = ref(false);
                const modalTitle = ref(null);
                const filtersHeading = ref(null);
                const mobileFiltersHeading = ref(null);
                const agencyFilterContainer = ref(null);
                const sponsorFilterContainer = ref(null);
                const filterDrawer = ref(null);
                let lastActiveElement = null;

                // Count active filters for badge
                const activeFilterCount = computed(() => {
                    let count = 0;
                    if (searchQuery.value) count++;
                    if (selectedAgency.value) count++;
                    if (selectedSponsor.value) count++;
                    if (filterRating.value !== 'all') count++;
                    count += filterBroad.value.length;
                    count += filterNarrow.value.length;
                    return count;
                });

                // Handle drawer animation
                watch(showFilterDrawer, async (val) => {
                    if (val) {
                        drawerReady.value = false;
                        lastActiveElement = document.activeElement;
                        await nextTick();
                        requestAnimationFrame(() => {
                            drawerReady.value = true;
                        });
                        // Focus first focusable element in drawer
                        await nextTick();
                        const firstInput = filterDrawer.value?.querySelector('input, button, select');
                        if (firstInput) firstInput.focus();
                    } else {
                        drawerReady.value = false;
                        await nextTick();
                        if (lastActiveElement && document.body.contains(lastActiveElement)) {
                            lastActiveElement.focus();
                        }
                    }
                });

                // A11y: Manage Focus for modals
                watch([activeBill, showAboutModal], async ([newBill, newAbout]) => {
                    if (newBill || newAbout) {
                        lastActiveElement = document.activeElement;
                        await nextTick();
                        const modal = document.querySelector('[role="dialog"]');
                        if (modal) {
                            const closeBtn = modal.querySelector('button[aria-label="Close Modal"]');
                            if (closeBtn) closeBtn.focus();
                        }
                    } else {
                        await nextTick();
                        if (lastActiveElement && document.body.contains(lastActiveElement)) {
                            lastActiveElement.focus();
                        }
                    }
                });

                const handleClickOutside = (event) => {
                    if (agencyFilterContainer.value && !agencyFilterContainer.value.contains(event.target)) {
                        showAgencyList.value = false;
                    }
                    if (sponsorFilterContainer.value && !sponsorFilterContainer.value.contains(event.target)) {
                        showSponsorList.value = false;
                    }
                };

                const clearFilters = async () => {
                    searchQuery.value = "";
                    agencySearch.value = "";
                    selectedAgency.value = "";
                    sponsorSearch.value = "";
                    selectedSponsor.value = "";
                    broadSubjectSearch.value = "";
                    narrowSubjectSearch.value = "";
                    filterBroad.value = [];
                    filterNarrow.value = [];
                    filterRating.value = "all";
                    sortBy.value = "date";
                    updateUrl();

                    // A11y: Manage focus so it doesn't get lost when the button disappears
                    await nextTick();
                    if (showFilterDrawer.value && mobileFiltersHeading.value) {
                        mobileFiltersHeading.value.focus();
                    } else if (filtersHeading.value) {
                        filtersHeading.value.focus();
                    }
                };

                watch([searchQuery, filterBroad, filterNarrow, sortBy, filterRating, selectedSponsor], () => { updateUrl(); });

                // Enforce sort rules when year changes
                watch(selectedYear, (newYear) => {
                    if (newYear === 2026) {
                        sortBy.value = 'date';
                    } else {
                        // For years < 2026, default to relevance if agency is selected, else bill number
                        sortBy.value = selectedAgency.value ? 'relevance' : 'bill_number';
                    }
                });

                const initFromUrl = async () => {
                    const params = new URLSearchParams(window.location.search);

                    // Check if we should show dashboard immediately
                    if (params.has('bill') || params.has('q') || params.has('agency') || params.has('broad') || params.has('narrow')) {
                        currentView.value = 'dashboard';
                    }

                    // Capture bill ID immediately before reactive changes trigger URL updates
                    if (params.get('bill')) pendingBillId.value = params.get('bill');

                    // Set Year first (this triggers the year watcher which resets sort)
                    if (params.get('year')) selectedYear.value = parseInt(params.get('year'));

                    if (params.get('agency')) {
                        const agencyKey = params.get('agency');
                        selectedAgency.value = agencyKey;
                        const found = agencyOptions.value.find(o => o.name === agencyKey);
                        agencySearch.value = found ? found.displayName : agencyKey;
                    }

                    if (params.get('sponsor')) {
                        const sponsor = params.get('sponsor');
                        selectedSponsor.value = sponsor;
                        sponsorSearch.value = sponsor;
                    }

                    if (params.get('q')) searchQuery.value = params.get('q');

                    const broad = params.getAll('broad');
                    if (broad.length > 0) filterBroad.value = broad;

                    const narrow = params.getAll('narrow');
                    if (narrow.length > 0) filterNarrow.value = narrow;

                    if (params.get('relevance')) {
                        filterRating.value = params.get('relevance');
                    }

                    // Apply sort parameter LAST
                    if (params.get('sort')) {
                        await nextTick();
                        sortBy.value = params.get('sort');
                    }
                };

                const enterDashboard = () => {
                    currentView.value = 'dashboard';
                    window.scrollTo(0, 0);
                    updateUrl();
                };

                const updateUrl = (usePushState = false) => {
                    const params = new URLSearchParams();
                    params.set('year', selectedYear.value);
                    params.set('sort', sortBy.value);
                    if (selectedAgency.value) params.set('agency', selectedAgency.value);
                    if (selectedSponsor.value) params.set('sponsor', selectedSponsor.value);

                    // Use active bill if set, otherwise preserve pending bill ID to prevent URL wiping during load
                    if (activeBill.value) {
                        params.set('bill', activeBill.value.BillNumber);
                    } else if (pendingBillId.value) {
                        params.set('bill', pendingBillId.value);
                    }

                    if (searchQuery.value) params.set('q', searchQuery.value);
                    filterBroad.value.forEach(val => params.append('broad', val));
                    filterNarrow.value.forEach(val => params.append('narrow', val));
                    if (filterRating.value !== 'all') params.set('relevance', filterRating.value);
                    const newUrl = `${window.location.pathname}?${params.toString()}`;
                    if (usePushState) {
                        window.history.pushState({ bill: activeBill.value?.BillNumber || null }, '', newUrl);
                    } else {
                        window.history.replaceState({ bill: activeBill.value?.BillNumber || null }, '', newUrl);
                    }
                    notifyParentOfUrlChange(usePushState);
                };

                const notifyParentOfUrlChange = (usePushState = false) => {
                    if (window.parent !== window) {
                        try {
                            const targetOrigin = window.location.hostname === 'localhost'
                                ? '*'
                                : 'https://ai.maryland.gov';
                            window.parent.postMessage({
                                type: 'legiassist-url-change',
                                params: window.location.search,
                                title: document.title,
                                pushState: usePushState
                            }, targetOrigin);
                        } catch (e) {
                            // Silently fail if postMessage blocked
                        }
                    }
                };

                const fetchAgencies = async () => {
                    try {
                        const resp = await fetch('data/maryland_agencies.json');
                        agenciesData.value = await resp.json();
                    } catch (e) {
                        console.error("Failed to load agencies", e);
                    }
                };

                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const resp = await fetch(`data/${selectedYear.value}rs/frontend_data.json`);
                        const data = await resp.json();
                        allBills.value = data.filter(b => b.agency_relevance && b.agency_relevance.length > 0);

                        // Check pendingBillId first (captured at init), fallback to URL param
                        const params = new URLSearchParams(window.location.search);
                        const targetBillId = pendingBillId.value || params.get('bill');

                        if (targetBillId) {
                            const found = allBills.value.find(b => b.BillNumber === targetBillId);
                            if (found) {
                                activeBill.value = found;
                                pendingBillId.value = null; // Clear pending once found
                            }
                        }
                    } catch (e) {
                        console.error("Load failed", e);
                        allBills.value = [];
                    } finally {
                        loading.value = false;
                    }
                };

                const agencyOptions = computed(() => {
                    return Object.values(agenciesData.value).map(agency => {
                        const name = agency["Agency Name"];
                        const acronym = agency["Acronym"];
                        const alias = agency["Alias"];
                        const displayName = acronym ? `${name} (${acronym})` : name;
                        const searchString = `${name} ${acronym || ''} ${alias || ''}`.toLowerCase();
                        
                        return {
                            name: name,
                            displayName: displayName,
                            searchString: searchString
                        };
                    }).sort((a, b) => a.displayName.localeCompare(b.displayName));
                });

                const filteredAgencies = computed(() => {
                    if (!agencySearch.value) return agencyOptions.value;
                    const query = agencySearch.value.toLowerCase();
                    return agencyOptions.value.filter(option => option.searchString.includes(query));
                });

                const uniqueSponsors = computed(() => {
                    const sponsors = new Set();
                    allBills.value.forEach(b => {
                        if (b.Sponsors && b.Sponsors.length > 0) {
                            b.Sponsors.forEach(s => sponsors.add(s.Name));
                        } else if (b.SponsorPrimary) {
                            sponsors.add(b.SponsorPrimary);
                        }
                    });
                    return Array.from(sponsors).sort();
                });

                const filteredSponsors = computed(() => {
                    if (!sponsorSearch.value && !selectedSponsor.value) return uniqueSponsors.value;
                    const query = sponsorSearch.value.toLowerCase();
                    return uniqueSponsors.value.filter(s => s.toLowerCase().includes(query));
                });

                const uniqueBroadSubjects = computed(() => {
                    const map = new Map();
                    allBills.value.forEach(b => {
                        b.BroadSubjects?.forEach(s => map.set(s.Code, s));
                    });
                    return Array.from(map.values()).sort((a,b) => a.Name.localeCompare(b.Name));
                });

                const uniqueNarrowSubjects = computed(() => {
                    const map = new Map();
                    allBills.value.forEach(b => {
                        b.NarrowSubjects?.forEach(s => map.set(s.Code, s));
                    });
                    return Array.from(map.values()).sort((a,b) => a.Name.localeCompare(b.Name));
                });

                const filteredBroadSubjects = computed(() => {
                    if (!broadSubjectSearch.value) return uniqueBroadSubjects.value;
                    const q = broadSubjectSearch.value.toLowerCase();
                    return uniqueBroadSubjects.value.filter(s => s.Name.toLowerCase().includes(q));
                });

                const filteredNarrowSubjects = computed(() => {
                    if (!narrowSubjectSearch.value) return uniqueNarrowSubjects.value;
                    const q = narrowSubjectSearch.value.toLowerCase();
                    return uniqueNarrowSubjects.value.filter(s => s.Name.toLowerCase().includes(q));
                });

                const filteredBills = computed(() => {
                    let results = allBills.value;

                    // 1. Filter by Agency (and Rating)
                    if (selectedAgency.value) {
                        results = results.filter(b => 
                            b.agency_relevance.some(a => a.agency_name === selectedAgency.value)
                        );
                        if (filterRating.value !== "all") {
                            const minRating = parseInt(filterRating.value);
                            results = results.filter(b => {
                                const rel = b.agency_relevance.find(ar => ar.agency_name === selectedAgency.value);
                                // Use >= to implement "or higher" logic
                                return rel && rel.relevance_rating >= minRating;
                            });
                        }
                    }

                    // 1b. Filter by Sponsor
                    if (selectedSponsor.value) {
                        results = results.filter(b => {
                            if (b.Sponsors && b.Sponsors.length > 0) {
                                return b.Sponsors.some(s => s.Name === selectedSponsor.value);
                            }
                            return b.SponsorPrimary === selectedSponsor.value;
                        });
                    }

                    // 2. Filter by Search Query
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        
                        const getVariants = (billNum) => {
                            if (!billNum) return [];
                            const lower = billNum.toLowerCase();
                            const variants = [lower];
                            const match = lower.match(/^([a-z]+)(\d+)$/);
                            if (match) {
                                const prefix = match[1];
                                const digits = match[2];
                                const number = parseInt(digits, 10);
                                variants.push(`${prefix}${number}`);
                                variants.push(`${prefix} ${number}`);
                                variants.push(`${prefix} ${digits}`);
                            }
                            return variants;
                        };

                        results = results.filter(b => {
                            const variants = getVariants(b.BillNumber);
                            if (b.CrossfileBillNumber) {
                                variants.push(...getVariants(b.CrossfileBillNumber));
                            }
                            
                            return variants.some(v => v.includes(q)) ||
                                b.Title.toLowerCase().includes(q) ||
                                b.bill_summary.toLowerCase().includes(q) ||
                                b.Synopsis.toLowerCase().includes(q);
                        });
                    }

                    // 3. Filter by Subjects
                    if (filterBroad.value.length > 0) {
                        results = results.filter(b => 
                            b.BroadSubjects?.some(s => filterBroad.value.includes(s.Name))
                        );
                    }
                    if (filterNarrow.value.length > 0) {
                        results = results.filter(b => 
                            b.NarrowSubjects?.some(s => filterNarrow.value.includes(s.Name))
                        );
                    }

                    // 4. Sorting Logic
                    return [...results].sort((a, b) => {
                        // Option A: Sort by Bill Number
                        if (sortBy.value === 'bill_number') {
                            return a.BillNumber.localeCompare(b.BillNumber, 'en', { numeric: true });
                        }

                        // Option B: Sort by Upcoming Action (Hearing/Reading)
                        if (sortBy.value === 'upcoming') {
                            const actionA = getNextAction(a);
                            const actionB = getNextAction(b);
                            
                            // Bills with actions come before bills without
                            if (actionA && !actionB) return -1;
                            if (!actionA && actionB) return 1;
                            
                            // If both have actions, sort by date (Ascending - soonest first)
                            if (actionA && actionB) {
                                return actionA.date - actionB.date;
                            }
                            
                            // Fallback to Bill Number if neither has an upcoming action
                            return a.BillNumber.localeCompare(b.BillNumber, 'en', { numeric: true });
                        }

                        // Option C: Sort by Relevance or Date

                        // Get relevance scores (0 if no agency selected)
                        const relA = selectedAgency.value 
                            ? (a.agency_relevance.find(ar => ar.agency_name === selectedAgency.value)?.relevance_rating || 0) 
                            : 0;
                        const relB = selectedAgency.value 
                            ? (b.agency_relevance.find(ar => ar.agency_name === selectedAgency.value)?.relevance_rating || 0) 
                            : 0;

                        // Get timestamps (default to 0 if missing)
                        const dateA = a.first_seen ? new Date(a.first_seen).getTime() : 0;
                        const dateB = b.first_seen ? new Date(b.first_seen).getTime() : 0;

                        if (sortBy.value === 'relevance' && selectedAgency.value) {
                            // Sort by Relevance (Desc), then Date (Desc)
                            if (relA !== relB) return relB - relA;
                            return dateB - dateA;
                        } else {
                            // Sort by Date (Desc), then Relevance (Desc)
                            if (dateA !== dateB) return dateB - dateA;
                            return relB - relA;
                        }
                    });
                });

                const selectAgency = (option) => {
                    let name, displayName;
                    if (typeof option === 'object') {
                        name = option.name;
                        displayName = option.displayName;
                    } else {
                        name = option;
                        const found = agencyOptions.value.find(o => o.name === name);
                        displayName = found ? found.displayName : name;
                    }

                    selectedAgency.value = name;
                    agencySearch.value = displayName;
                    showAgencyList.value = false;

                    if (typeof gtag === 'function') {
                        gtag('event', 'agency_selected', {
                            'agency_name': name
                        });
                    }
                    
                    // Update sort preference based on year
                    if (selectedYear.value < 2026) {
                        sortBy.value = 'relevance';
                    }
                    
                    updateUrl();
                };

                const clearAgency = async () => {
                    selectedAgency.value = '';
                    agencySearch.value = '';
                    filterRating.value = 'all';
                    showAgencyList.value = true; // Explicitly open the dropdown
                    
                    // If we are in an older year, we must revert to bill_number 
                    // because 'relevance' is no longer an option without an agency
                    if (selectedYear.value < 2026) {
                        sortBy.value = 'bill_number';
                    } else {
                        sortBy.value = 'date';
                    }

                    updateUrl();
                    await nextTick(); 
                    const input = document.getElementById('agency-filter-input');
                    if (input) input.focus();
                };

                const selectSponsor = (sponsor) => {
                    selectedSponsor.value = sponsor;
                    sponsorSearch.value = sponsor;
                    showSponsorList.value = false;
                    updateUrl();
                };

                const clearSponsor = async () => {
                    selectedSponsor.value = '';
                    sponsorSearch.value = '';
                    showSponsorList.value = true;
                    updateUrl();
                    await nextTick();
                    const input = document.getElementById('sponsor-filter-input');
                    if (input) input.focus();
                };

                const getRelevance = (bill) => {
                    if (!selectedAgency.value || !bill.agency_relevance) return null;
                    return bill.agency_relevance.find(a => a.agency_name === selectedAgency.value);
                };

                const openBill = (bill) => {
                    activeBill.value = bill;
                    updateUrl(true);
                };

                const closeBill = () => {
                    activeBill.value = null;
                    updateUrl(true);
                };

                const trapFocus = (e) => {
                    const modal = document.querySelector('[role="dialog"]');
                    if (!modal) return;
                    const focusableSelectors = [
                        'button:not([disabled]):not([aria-hidden="true"])',
                        'a[href]:not([aria-hidden="true"])',
                        'input:not([disabled]):not([type="hidden"])',
                        'select:not([disabled])',
                        'textarea:not([disabled])',
                        '[tabindex]:not([tabindex="-1"]):not([aria-hidden="true"])'
                    ].join(', ');
                    const focusableElements = Array.from(modal.querySelectorAll(focusableSelectors))
                        .filter(el => el.offsetParent !== null);
                    if (focusableElements.length === 0) return;
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                };

                const getTestimonyDeadline = (hearingDate) => {
                    if (!hearingDate) return null;
                    const date = new Date(hearingDate);
                    const day = date.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
                    
                    let daysToSubtract = 0;
                    if (day === 1 || day === 2) { // Monday, Tuesday
                        daysToSubtract = 4;
                    } else if (day >= 3 && day <= 5) { // Wednesday, Thursday, Friday
                        daysToSubtract = 2;
                    } else {
                        return null; // No rule defined for weekends
                    }
                    
                    const deadlineDate = new Date(date);
                    deadlineDate.setDate(date.getDate() - daysToSubtract);
                    deadlineDate.setHours(18, 0, 0, 0); // Always 6:00 PM
                    return deadlineDate;
                };

                const getNextAction = (bill) => {
                    const now = new Date();
                    const actions = [
                        { label: 'Hearing', date: bill.HearingDateTimePrimaryHouseOfOrigin, isTime: true },
                        { label: 'Hearing', date: bill.HearingDateTimeSecondaryHouseOfOrigin, isTime: true },
                        { label: '2nd Reading', date: bill.SecondReadingDateHouseOfOrigin, isTime: false },
                        { label: '3rd Reading', date: bill.ThirdReadingDateHouseOfOrigin, isTime: false },
                        { label: 'Opp. Hearing', date: bill.HearingDateTimePrimaryOppositeHouse, isTime: true },
                        { label: 'Opp. Hearing', date: bill.HearingDateTimeSecondaryOppositeHouse, isTime: true },
                        { label: 'Opp. 2nd', date: bill.SecondReadingDateOppositeHouse, isTime: false },
                        { label: 'Opp. 3rd', date: bill.ThirdReadingDateOppositeHouse, isTime: false }
                    ];
                    const upcoming = actions
                        .filter(a => a.date)
                        .map(a => ({ ...a, date: new Date(a.date) }))
                        .filter(a => a.date >= now.setHours(0, 0, 0, 0))
                        .sort((a, b) => a.date - b.date);
                    return upcoming.length > 0 ? upcoming[0] : null;
                };

                const formatCurrency = (val) => {
                    if (val === 0) return "No Direct Fiscal Impact";
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
                };

                const formatDate = (ds) => ds ? new Date(ds).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                const formatTimestamp = (ds) => ds ? new Date(ds).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric' }) : '';
                const formatTime = (ds) => ds ? new Date(ds).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
                const isNew = (dateStr) => {
                    if (!dateStr) return false;
                    const d = new Date(dateStr);
                    const today = new Date();
                    return d.getDate() === today.getDate() &&
                        d.getMonth() === today.getMonth() &&
                        d.getFullYear() === today.getFullYear();
                };

                const exportToExcel = () => {
                    const rows = filteredBills.value.map(b => ({
                        Bill: b.BillNumber,
                        Title: b.Title,
                        MGA_Link: `https://mgaleg.maryland.gov/mgawebsite/Legislation/Details/${b.BillNumber}?ys=${selectedYear.value}RS`,
                        Agency_Rating: getRelevance(b)?.relevance_rating || '',
                        Relevance_Note: getRelevance(b)?.relevance_explanation || '',
                        Summary: b.bill_summary || '',
                        Fiscal_Impact: b.fiscal_impact_summary || '',
                        Funding: (b.funding !== null && b.funding !== undefined) ? b.funding : '',
                        Sponsor: b.SponsorPrimary || '',
                        Status: b.Status || '',
                        First_Seen: b.first_seen ? new Date(b.first_seen).toLocaleDateString() : '',
                        Last_Updated: b.last_updated ? new Date(b.last_updated).toLocaleDateString() : '',
                        Broad_Subjects: b.BroadSubjects?.map(s => s.Name).join('; ') || '',
                        Narrow_Subjects: b.NarrowSubjects?.map(s => s.Name).join('; ') || ''
                    }));
                    if (rows.length === 0) {
                        announceToScreenReader('No bills to export.');
                        return;
                    }
                    const header = Object.keys(rows[0]).join(',');
                    const csv = [header, ...rows.map(row => 
                        Object.values(row).map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')
                    )].join('\n');
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `MD_Legislation_Export_${selectedYear.value}.csv`;
                    link.click();
                    setTimeout(() => URL.revokeObjectURL(link.href), 100);
                    announceToScreenReader(`Export complete. ${rows.length} bills downloaded as CSV.`);
                };

                const focusFirstOption = () => {
                    const firstOption = document.querySelector('#agency-results-list li');
                    if (firstOption) firstOption.focus();
                };

                const announceToScreenReader = (message) => {
                    const announcement = document.createElement('div');
                    announcement.setAttribute('role', 'status');
                    announcement.setAttribute('aria-live', 'polite');
                    announcement.setAttribute('aria-atomic', 'true');
                    announcement.className = 'sr-only';
                    announcement.textContent = message;
                    document.body.appendChild(announcement);
                    setTimeout(() => { document.body.removeChild(announcement); }, 1000);
                };

                const handleFocusOut = (type, event) => {
                    // Only close if the new focused element (relatedTarget) is OUTSIDE the container
                    if (!event.currentTarget.contains(event.relatedTarget)) {
                        if (type === 'agency') showAgencyList.value = false;
                        if (type === 'sponsor') showSponsorList.value = false;
                    }
                };

                const scrollToFocusedItem = (event) => {
                    // Find the wrapper (usa-checkbox) and scroll it into view within its container
                    const wrapper = event.target.closest('.usa-checkbox');
                    if (wrapper) {
                        wrapper.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                };

                const trapFocusDrawer = (e) => {
                    const drawer = filterDrawer.value;
                    if (!drawer || e.key !== 'Tab') return;

                    const focusableSelectors = [
                        'button:not([disabled]):not([aria-hidden="true"])',
                        'a[href]:not([aria-hidden="true"])',
                        'input:not([disabled]):not([type="hidden"])',
                        'select:not([disabled])',
                        'textarea:not([disabled])',
                        '[tabindex]:not([tabindex="-1"]):not([aria-hidden="true"])'
                    ].join(', ');

                    const focusableElements = Array.from(drawer.querySelectorAll(focusableSelectors))
                        .filter(el => el.offsetParent !== null); // Ensure visible

                    if (focusableElements.length === 0) return;

                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];

                    if (e.shiftKey) { // Shift + Tab
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else { // Tab
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                };

                onMounted(async () => {
                    await fetchAgencies();
                    initFromUrl();
                    fetchData();
                    window.addEventListener('click', handleClickOutside);
                    // Listen for URL state from parent
                    window.addEventListener('message', (event) => {
                        const allowedOrigins = [
                            'https://ai.maryland.gov',
                            'http://localhost:8000'
                        ];
                        if (!allowedOrigins.includes(event.origin)) return;
                        
                        if (event.data.type === 'legiassist-set-params') {
                            const params = new URLSearchParams(event.data.params);
                            
                            // Update filters from params
                            if (params.get('year')) selectedYear.value = parseInt(params.get('year'));
                            if (params.get('agency')) {
                                selectedAgency.value = params.get('agency');
                                agencySearch.value = params.get('agency');
                            }
                            if (params.get('sponsor')) {
                                selectedSponsor.value = params.get('sponsor');
                                sponsorSearch.value = params.get('sponsor');
                            }
                            if (params.get('q')) searchQuery.value = params.get('q');
                            if (params.get('relevance')) filterRating.value = params.get('relevance');
                            if (params.get('sort')) sortBy.value = params.get('sort');
                            
                            const broad = params.getAll('broad');
                            filterBroad.value = broad.length > 0 ? broad : [];
                            
                            const narrow = params.getAll('narrow');
                            filterNarrow.value = narrow.length > 0 ? narrow : [];
                            
                            // Handle bill modal - if data already loaded, just open/close modal
                            const billId = params.get('bill');
                            if (allBills.value.length > 0) {
                                // Data already loaded, just update modal state
                                if (billId) {
                                    const found = allBills.value.find(b => b.BillNumber === billId);
                                    activeBill.value = found || null;
                                } else {
                                    activeBill.value = null;
                                }
                            } else {
                                // Need to fetch data first
                                fetchData().then(() => {
                                    if (billId) {
                                        const found = allBills.value.find(b => b.BillNumber === billId);
                                        if (found) activeBill.value = found;
                                    }
                                });
                            }
                        }
                    });

                    window.addEventListener('popstate', (event) => {
                        // Skip if embedded - let parent iframe wrapper handle via postMessage
                        if (window.parent !== window) return;
                        
                        const params = new URLSearchParams(window.location.search);
                        const billId = params.get('bill');
                        if (billId) {
                            const found = allBills.value.find(b => b.BillNumber === billId);
                            activeBill.value = found || null;
                        } else {
                            activeBill.value = null;
                        }
                    });
                });

                onUnmounted(() => {
                    window.removeEventListener('click', handleClickOutside);
                });

                return {
                    allBills, loading, selectedYear, searchQuery, agencySearch, selectedAgency,
                    showAgencyList, sponsorSearch, selectedSponsor, showSponsorList, filterBroad, filterNarrow, filterRating, activeBill, showAboutModal,
                    showFilterDrawer, drawerReady, activeFilterCount, sortBy,
                    filteredAgencies, uniqueSponsors, filteredSponsors, uniqueBroadSubjects, uniqueNarrowSubjects, filteredBills,
                    broadSubjectSearch, narrowSubjectSearch, filteredBroadSubjects, filteredNarrowSubjects,
                    selectAgency, selectSponsor, getRelevance, openBill, closeBill, formatCurrency,
                    formatDate, formatTime, formatTimestamp, isNew, exportToExcel, fetchData, getNextAction, getTestimonyDeadline,
                    modalTitle, trapFocus, trapFocusDrawer, clearAgency, clearSponsor, clearFilters, agencyFilterContainer, sponsorFilterContainer,
                    filterDrawer, focusFirstOption, announceToScreenReader,
                    filtersHeading, mobileFiltersHeading,
                    currentView, enterDashboard, handleFocusOut, scrollToFocusedItem
                };
            }
        }).mount('#app');
    </script>
</body>
</html>