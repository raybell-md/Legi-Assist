<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maryland Legi-Assist | Research & Tracking</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .md-flag-strip {
            background: linear-gradient(90deg, #bf0d3e 25%, #fff 25%, #fff 50%, #000 50%, #000 75%, #e0aa0f 75%);
            height: 8px;
            width: 100%;
        }
        [v-cloak] { display: none; }

        .form-select-multi {
            max-height: 120px;
            overflow-y: auto;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        [tabindex="0"]:focus-visible {
            outline: 2px solid #991b1b;
            outline-offset: 2px;
        }
        
        button:focus:not(:focus-visible),
        a:focus:not(:focus-visible) {
            outline: none;
        }
        
        @media (prefers-contrast: high) {
            .border-gray-200 { border-color: #000; }
            .text-slate-500, .text-slate-600 { color: #000; }
            .bg-red-50 { background-color: #fee; border: 1px solid #991b1b; }
        }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            .animate-spin { animation: none; }
        }
        
        @media (pointer: coarse) {
            button, a, input[type="checkbox"], select {
                min-height: 44px;
                min-width: 44px;
            }
            .form-select-multi label {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
        }
        
        article:focus-within {
            border-color: #fca5a5;
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 focus:bg-white focus:text-red-800 focus:p-4 focus:font-bold focus:border-2 focus:border-red-800 focus:rounded-lg focus:shadow-xl">
        Skip to main content
    </a>
    <div id="app" v-cloak class="flex flex-col h-full">
        <header class="bg-white shadow-sm z-20 shrink-0">
            <div class="md-flag-strip"></div>
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <i class="ph ph-shield-check text-3xl text-red-800" aria-hidden="true"></i>
                        <div>
                            <a href="./" class="hover:opacity-70 transition-opacity">
                                <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Maryland Legi-Assist</h1>
                            </a>
                            <div class="flex items-center gap-1">
                                <p class="text-xs text-slate-500 uppercase font-bold tracking-widest">AI-assisted Legislative Research</p>
                                <button @click="showAboutModal = true" class="text-slate-400 hover:text-red-800 transition-colors focus:outline-none focus:ring-1 focus:ring-red-800 rounded" aria-label="Learn more about this site's unique features">
                                    <i class="ph ph-question text-base" aria-hidden="true"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
                        <div ref="agencyFilterContainer" class="relative flex-1 lg:w-80">
                            <i class="ph ph-buildings absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" aria-hidden="true"></i>
                            <input 
                                v-model="agencySearch" 
                                @focus="showAgencyList = true"
                                @keydown.down.prevent="focusFirstOption"
                                @keydown.escape="showAgencyList = false"
                                type="text" 
                                id="agency-filter-input"
                                role="combobox"
                                aria-autocomplete="list"
                                aria-label="Filter by Agency Relevance"
                                aria-haspopup="listbox"
                                :aria-expanded="showAgencyList && filteredAgencies.length > 0"
                                aria-controls="agency-results-list"
                                placeholder="Filter by Agency Relevance..." 
                                class="pl-10 pr-12 py-2 border border-gray-500 placeholder-gray-600 text-slate-900 rounded-lg focus:ring-2 focus:ring-red-800 w-full outline-none font-medium"
                            >
                            <ul 
                                v-if="showAgencyList && filteredAgencies.length" 
                                id="agency-results-list"
                                role="listbox"
                                aria-label="Agency Search Results"
                                class="absolute left-0 right-0 mt-1 bg-white border border-gray-500 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto list-none p-0"
                            >
                                <li 
                                    v-for="agency in filteredAgencies" 
                                    :key="agency"
                                    @click="selectAgency(agency)"
                                    @keydown.enter="selectAgency(agency)"
                                    @keydown.space.prevent="selectAgency(agency)"
                                    tabindex="0"
                                    role="option"
                                    :aria-selected="agency === selectedAgency"
                                    class="px-4 py-2 hover:bg-red-50 focus:bg-red-50 cursor-pointer text-sm border-b border-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-red-800 text-slate-800"
                                >
                                    {{ agency }}
                                </li>
                            </ul>
                            <button 
                                v-if="selectedAgency" 
                                @click="clearAgency" 
                                aria-label="Clear selected agency"
                                class="absolute right-3 top-1/2 -translate-y-1/2 p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-red-800"
                            >
                                <i class="ph ph-x-circle text-slate-500 hover:text-red-600" aria-hidden="true"></i>
                            </button>
                        </div>

                        <select v-model="selectedYear" @change="fetchData" aria-label="Select Legislative Session" class="px-4 py-2 border border-gray-500 rounded-lg bg-white focus:ring-2 focus:ring-red-800 outline-none font-bold">
                            <option v-for="year in [2026, 2025, 2024, 2023]" :value="year">{{ year }} Session</option>
                        </select>

                        <button @click="exportToExcel" class="flex items-center gap-2 px-4 py-2 bg-green-700 hover:bg-green-800 text-white rounded-lg transition-colors text-sm font-medium focus:ring-2 focus:ring-offset-2 focus:ring-green-700 outline-none">
                            <i class="ph ph-file-xls" aria-hidden="true"></i> Export
                        </button>

                        <a href="https://github.com/Maryland-State-Innovation-Team/Legi-Assist/" target="_blank" rel="noopener" class="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-black text-white rounded-lg transition-colors text-sm font-medium focus:ring-2 focus:ring-offset-2 focus:ring-slate-800 outline-none">
                            <i class="ph ph-github-logo" aria-hidden="true"></i> 
                            GitHub
                            <span class="sr-only">(opens in new tab)</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-hidden flex flex-col md:flex-row">
            <aside aria-label="Filter options" class="w-full md:w-80 bg-white border-r border-gray-200 overflow-y-auto p-4 space-y-6">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xs font-black text-gray-500 uppercase tracking-widest">Filters</h2>
                    <button 
                        @click="clearFilters" 
                        class="text-[10px] font-bold text-red-700 hover:text-red-900 uppercase bg-red-50 px-2 py-1 rounded border border-red-100 transition-colors"
                    >
                        Clear All
                    </button>
                </div>
                
                <div role="search">
                    <label for="keyword-search-input" class="block text-xs font-bold text-gray-500 uppercase mb-2">Keyword Search</label>
                    <div class="relative">
                        <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" aria-hidden="true"></i>
                        <input id="keyword-search-input" v-model="searchQuery" type="text" class="w-full pl-9 pr-4 py-2 border border-gray-400 rounded-lg text-sm text-slate-900 placeholder-gray-600 focus:ring-2 focus:ring-red-800 outline-none" placeholder="Title, summary, ID...">
                    </div>
                </div>
                
                <div v-if="selectedAgency" class="p-3 bg-red-50 rounded-lg border border-red-100">
                    <label for="impact-rating-filter" class="block text-[10px] font-black text-red-800 uppercase mb-2 tracking-wider">Filter by Impact Level</label>
                    <select id="impact-rating-filter" v-model="filterRating" class="w-full bg-white border border-gray-400 rounded px-2 py-1 text-sm text-slate-900 outline-none focus:ring-2 focus:ring-red-800">
                        <option value="all">All Relevance Levels</option>
                        <option value="5">5 - Primary Relevance</option>
                        <option value="4">4 - High Relevance</option>
                        <option value="3">3 - Moderate Relevance</option>
                        <option value="2">2 - Low Relevance</option>
                        <option value="1">1 - Minimal Relevance</option>
                    </select>
                </div>
                
                <fieldset>
                    <legend class="block text-xs font-bold text-gray-500 uppercase mb-2">Broad Subjects</legend>
                    <div class="form-select-multi border border-gray-400 rounded-lg p-2 space-y-1" role="group">
                        <label v-for="sub in uniqueBroadSubjects" :key="sub.Code" class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-1 rounded">
                            <input type="checkbox" v-model="filterBroad" :value="sub.Name" class="rounded text-red-800 focus:ring-red-800">
                            <span>{{ sub.Name }}</span>
                        </label>
                    </div>
                </fieldset>

                <fieldset>
                    <legend class="block text-xs font-bold text-gray-500 uppercase mb-2">Narrow Subjects</legend>
                    <div class="form-select-multi border border-gray-400 rounded-lg p-2 space-y-1" role="group">
                        <label v-for="sub in uniqueNarrowSubjects" :key="sub.Code" class="flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded">
                            <input type="checkbox" v-model="filterNarrow" :value="sub.Name" class="rounded text-red-800 focus:ring-red-800">
                            <span>{{ sub.Name }}</span>
                        </label>
                    </div>
                </fieldset>
            </aside>

            <section class="flex-1 overflow-y-auto bg-gray-50 p-4 relative">
                <div v-if="loading" role="status" aria-live="polite" class="absolute inset-0 z-10 bg-white/80 flex items-center justify-center flex-col">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-red-800 mb-4"></div>
                    <p class="font-medium text-slate-600">Syncing Legislative Data...</p>
                </div>

                <div class="max-w-5xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <div role="status" aria-live="polite" aria-atomic="true" class="sr-only">
                            <template v-if="loading">Loading bills...</template>
                            <template v-else>
                                {{ filteredBills.length }} bills match your search criteria<template v-if="selectedAgency"> for {{ selectedAgency }}</template>.
                            </template>
                        </div>
                        <h2 class="text-xl font-bold text-slate-800" aria-hidden="true">
                            {{ filteredBills.length }} Bills Match
                            <span v-if="selectedAgency" class="text-red-800">for {{ selectedAgency }}</span>
                        </h2>
                    </div>

                    <div class="space-y-4">
                        <article 
                            v-for="bill in filteredBills" 
                            :key="bill.BillNumber"
                            class="bg-white rounded-xl border border-gray-200 shadow-sm hover:border-red-300 transition-all group focus-within:ring-2 focus-within:ring-red-800 focus-within:border-red-800"
                        >
                            <button
                                @click="openBill(bill)"
                                class="w-full text-left p-5 focus:outline-none"
                                :aria-label="'View details for bill ' + bill.BillNumber + ': ' + bill.Title"
                            >
                                <div class="flex justify-between items-start gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-1">
                                            <span class="text-lg font-black text-red-800 group-hover:underline">
                                                {{ bill.BillNumber }}{{ bill.CrossfileBillNumber ? '/' + bill.CrossfileBillNumber : '' }}
                                            </span>
                                            <span v-if="getRelevance(bill)" class="px-2 py-0.5 bg-amber-100 text-amber-800 text-xs font-bold rounded">
                                                Relevance Rating: {{ getRelevance(bill).relevance_rating }}/5
                                            </span>
                                        </div>
                                        <h3 class="font-bold text-slate-900 leading-tight mb-2">{{ bill.Title }}</h3>
                                        <p class="text-sm text-slate-600 line-clamp-2">{{ bill.bill_summary }}</p>
                                    </div>

                                    <div v-if="selectedYear === 2026 && getNextAction(bill)" class="text-right shrink-0">
                                        <div class="text-[10px] font-bold text-red-700 uppercase tracking-tighter">{{ getNextAction(bill).label }}</div>
                                        <div class="text-sm font-bold text-slate-700">{{ formatDate(getNextAction(bill).date) }}</div>
                                        <div v-if="getNextAction(bill).isTime" class="text-xs text-slate-500">{{ formatTime(getNextAction(bill).date) }}</div>
                                    </div>
                                </div>
                            </button>
                        </article>
                    </div>
                </div>
            </section>
        </main>

        <transition name="fade">
            <div 
                v-if="activeBill" 
                role="dialog" 
                aria-modal="true" 
                aria-labelledby="modal-title"
                class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" 
                @click.self="closeBill"
                @keydown.esc="closeBill"
                @keydown.tab="trapFocus"
            >
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden">
                    <header class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-3 mb-1">
                                <h2 id="modal-title" ref="modalTitle" tabindex="-1" class="text-3xl font-black text-red-900 outline-none">
                                    {{ activeBill.BillNumber }}{{ activeBill.CrossfileBillNumber ? '/' + activeBill.CrossfileBillNumber : '' }}
                                </h2>
                                <span class="px-3 py-1 bg-white border border-gray-200 rounded-full text-xs font-bold text-slate-500">{{ activeBill.YearAndSession }}</span>
                            </div>
                            <h3 class="text-lg font-bold text-slate-800">{{ activeBill.Title }}</h3>
                        </div>
                        <button @click="closeBill" aria-label="Close Modal" class="p-2 hover:bg-gray-200 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-red-800">
                            <i class="ph ph-x text-2xl" aria-hidden="true"></i>
                        </button>
                    </header>

                    <div class="flex-1 overflow-y-auto p-6 md:p-10">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                            <div class="lg:col-span-2 space-y-8">
                                <section v-if="getRelevance(activeBill)" aria-labelledby="relevance-heading" class="bg-red-50 border-l-4 border-red-800 p-6 rounded-r-xl">
                                    <h4 id="relevance-heading" class="text-red-900 font-bold uppercase text-xs tracking-widest mb-2">Agency Relevance: {{ selectedAgency }}</h4>
                                    <p class="text-slate-800 font-medium leading-relaxed">{{ getRelevance(activeBill).relevance_explanation }}</p>
                                </section>

                                <section aria-labelledby="summary-heading">
                                    <h4 id="summary-heading" class="text-slate-600 font-bold uppercase text-xs tracking-widest mb-3">Plain-English Summary</h4>
                                    <p class="text-slate-700 leading-relaxed text-lg">{{ activeBill.bill_summary }}</p>
                                </section>

                                <section aria-labelledby="fiscal-heading">
                                    <h4 id="fiscal-heading" class="text-slate-600 font-bold uppercase text-xs tracking-widest mb-3">Fiscal Impact Analysis</h4>
                                    <div class="bg-emerald-50 text-emerald-900 p-5 rounded-xl border border-emerald-100">
                                        {{ activeBill.fiscal_impact_summary }}
                                    </div>
                                </section>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <h5 class="text-xs font-bold text-slate-600 uppercase mb-2">Responsible Party</h5>
                                        <p class="font-bold text-slate-800">{{ activeBill.responsible_party || 'N/A' }}</p>
                                    </div>
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <h5 class="text-xs font-bold text-slate-600 uppercase mb-2">Stakeholders</h5>
                                        <p class="text-sm text-slate-700">{{ activeBill.stakeholders }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <dl class="bg-slate-50 rounded-xl p-5 space-y-4">
                                    <div>
                                        <dt class="text-[10px] font-bold text-slate-600 uppercase">Primary Sponsor</dt>
                                        <dd class="font-bold text-slate-900">{{ activeBill.SponsorPrimary }}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-[10px] font-bold text-slate-600 uppercase">Current Status</dt>
                                        <dd class="text-sm font-medium text-red-800">{{ activeBill.Status }}</dd>
                                    </div>
                                    <div v-if="activeBill.funding !== null">
                                        <dt class="text-[10px] font-bold text-slate-600 uppercase">Est. Funding Impact</dt>
                                        <dd class="text-lg font-black text-emerald-700">{{ formatCurrency(activeBill.funding) }}</dd>
                                    </div>
                                </dl>

                                <div>
                                    <h4 class="text-xs font-bold text-slate-600 uppercase mb-2">Subjects</h4>
                                    <ul class="flex flex-wrap gap-2" aria-label="Bill subjects">
                                        <li v-for="s in activeBill.BroadSubjects" class="px-2 py-1 bg-slate-200 text-slate-700 rounded text-[10px] font-bold uppercase">{{ s.Name }}</li>
                                        <li v-for="s in activeBill.NarrowSubjects" class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-[10px]">{{ s.Name }}</li>
                                    </ul>
                                </div>

                                <a :href="'https://mgaleg.maryland.gov/mgawebsite/Legislation/Details/' + activeBill.BillNumber + '?ys=' + selectedYear + 'RS'" 
                                target="_blank"
                                rel="noopener"
                                class="flex items-center justify-center gap-2 w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-black transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-slate-900">
                                    View Bill on MGA
                                    <i class="ph ph-arrow-square-out" aria-hidden="true"></i>
                                    <span class="sr-only">(opens in new tab)</span>
                                </a>
                            </div>
                        </div>

                        <div class="mt-10 pt-6 border-t border-gray-100">
                            <div class="flex flex-col sm:flex-row gap-3 items-start bg-slate-50 p-4 rounded-xl border border-slate-200 text-slate-600">
                                <i class="ph ph-robot text-xl shrink-0 mt-0.5 text-slate-400" aria-hidden="true"></i>
                                <div class="text-xs font-medium leading-relaxed">
                                    <strong class="block mb-1 text-slate-700 uppercase tracking-wide">Automated Summary Disclaimer</strong>
                                    <p>
                                        The summary content, relevance ratings, and fiscal analysis displayed here were generated using AI and may contain inaccuracies. 
                                        This tool is for research assistance only. Please verify all details directly against the official 
                                        <a :href="'https://mgaleg.maryland.gov/mgawebsite/Legislation/Details/' + activeBill.BillNumber + '?ys=' + selectedYear + 'RS'" target="_blank" rel="noopener" class="underline hover:text-red-800 text-slate-900 font-bold decoration-slate-400 underline-offset-2">
                                            Maryland General Assembly website
                                            <span class="sr-only">(opens in new tab)</span>
                                        </a>.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div 
                v-if="showAboutModal" 
                role="dialog" 
                aria-modal="true" 
                aria-labelledby="about-modal-title"
                class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" 
                @click.self="showAboutModal = false"
                @keydown.esc="showAboutModal = false"
                @keydown.tab="trapFocus"
            >
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col overflow-hidden">
                    <header class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h2 id="about-modal-title" ref="modalTitle" tabindex="-1" class="text-xl font-bold text-slate-900 outline-none">
                            About Maryland Legi-Assist
                        </h2>
                        <button @click="showAboutModal = false" aria-label="Close Modal" class="p-2 hover:bg-gray-200 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-red-800">
                            <i class="ph ph-x text-xl" aria-hidden="true"></i>
                        </button>
                    </header>
                    <div class="p-8 space-y-6">
                        <section class="flex gap-4">
                            <div class="bg-red-50 p-3 rounded-lg h-fit text-red-800">
                                <i class="ph ph-file-text text-2xl" aria-hidden="true"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-900 mb-1">LLM-Friendly Conversion</h3>
                                <p class="text-slate-600 text-sm leading-relaxed">
                                    Unlike standard PDF tools, our custom conversion process identifies and preserves 
                                    <span class="font-mono bg-gray-100 px-1 rounded text-red-700">~struck-through~</span> 
                                    language. This ensures the AI understands exactly what is being removed from current law, 
                                    not just what is being added.
                                </p>
                            </div>
                        </section>

                        <section class="flex gap-4">
                            <div class="bg-blue-50 p-3 rounded-lg h-fit text-blue-800">
                                <i class="ph ph-git-merge text-2xl" aria-hidden="true"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-900 mb-1">Real-time Amendment Previews</h3>
                                <p class="text-slate-600 text-sm leading-relaxed">
                                    Legislative text changes fast. We use AI to programmatically apply adopted 
                                    amendments to the base bill text, providing an "early enrolled" preview 
                                    before official documents are even published by the MGA.
                                </p>
                            </div>
                        </section>

                        <section class="flex gap-4">
                            <div class="bg-emerald-50 p-3 rounded-lg h-fit text-emerald-800">
                                <i class="ph ph-sparkle text-2xl" aria-hidden="true"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-900 mb-1">AI-Generated Summaries & Ratings</h3>
                                <p class="text-slate-600 text-sm leading-relaxed">
                                    Every bill is enhanced with plain-English summaries, fiscal impact extractions, 
                                    and relevance ratings for dozens of Maryland State agencies, helping you 
                                    identify what matters most at a glance.
                                </p>
                            </div>
                        </section>
                    </div>
                    <footer class="p-6 bg-slate-50 border-t border-gray-100 flex justify-end">
                        <button @click="showAboutModal = false" class="px-6 py-2 bg-slate-900 text-white rounded-lg font-bold hover:bg-black transition-colors">
                            Got it
                        </button>
                    </footer>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const allBills = ref([]);
                const loading = ref(true);
                const selectedYear = ref(2026);
                const searchQuery = ref("");
                const agencySearch = ref("");
                const selectedAgency = ref("");
                const showAgencyList = ref(false);
                const filterBroad = ref([]);
                const filterNarrow = ref([]);
                const filterRating = ref("all");
                const activeBill = ref(null);
                const showAboutModal = ref(false);
                const modalTitle = ref(null);
                const agencyFilterContainer = ref(null);
                let lastActiveElement = null;

                // A11y: Manage Focus
                watch([activeBill, showAboutModal], async ([newBill, newAbout]) => {
                    if (newBill || newAbout) {
                        // Modal Opening: Save current focus
                        lastActiveElement = document.activeElement;
                        await nextTick();
                        
                        // Focus the close button (first interactive element) instead of title
                        const modal = document.querySelector('[role="dialog"]');
                        if (modal) {
                            const closeBtn = modal.querySelector('button[aria-label="Close Modal"]');
                            if (closeBtn) {
                                closeBtn.focus();
                            }
                        }
                    } else {
                        // Modal Closing: Return focus to trigger
                        await nextTick();
                        if (lastActiveElement && document.body.contains(lastActiveElement)) {
                            lastActiveElement.focus();
                        }
                    }
                });

                const handleClickOutside = (event) => {
                    if (agencyFilterContainer.value && !agencyFilterContainer.value.contains(event.target)) {
                        showAgencyList.value = false;
                    }
                };

                const clearFilters = () => {
                    searchQuery.value = "";
                    agencySearch.value = "";
                    selectedAgency.value = "";
                    filterBroad.value = [];
                    filterNarrow.value = [];
                    filterRating.value = "all";
                    updateUrl();
                };

                // Sync Filters to URL
                watch([searchQuery, filterBroad, filterNarrow], () => {
                    updateUrl();
                });

                // Initialize from URL
                const initFromUrl = () => {
                    const params = new URLSearchParams(window.location.search);
                    if (params.get('year')) selectedYear.value = parseInt(params.get('year'));
                    
                    if (params.get('agency')) {
                        selectedAgency.value = params.get('agency');
                        agencySearch.value = params.get('agency');
                    }

                    // Restore Keyword Search
                    if (params.get('q')) {
                        searchQuery.value = params.get('q');
                    }

                    // Restore Broad Subjects (multi-value)
                    const broad = params.getAll('broad');
                    if (broad.length > 0) {
                        filterBroad.value = broad;
                    }

                    // Restore Narrow Subjects (multi-value)
                    const narrow = params.getAll('narrow');
                    if (narrow.length > 0) {
                        filterNarrow.value = narrow;
                    }

                    if (params.get('bill')) {
                        // We'll open this after data loads
                    }
                };

                const updateUrl = () => {
                    const params = new URLSearchParams();
                    params.set('year', selectedYear.value);
                    
                    if (selectedAgency.value) params.set('agency', selectedAgency.value);
                    if (activeBill.value) params.set('bill', activeBill.value.BillNumber);
                    
                    // Add Keyword Search
                    if (searchQuery.value) params.set('q', searchQuery.value);

                    // Add Broad Subjects
                    filterBroad.value.forEach(val => params.append('broad', val));

                    // Add Narrow Subjects (URLSearchParams handles encoding automatically)
                    filterNarrow.value.forEach(val => params.append('narrow', val));
                    
                    const newUrl = `${window.location.pathname}?${params.toString()}`;
                    
                    // Use replaceState to update URL without cluttering browser history during filtering
                    window.history.replaceState({}, '', newUrl);
                };

                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const resp = await fetch(`data/${selectedYear.value}rs/frontend_data.json`);
                        const data = await resp.json();
                        // Filter out bills without agency processing
                        allBills.value = data.filter(b => b.agency_relevance && b.agency_relevance.length > 0);
                        
                        // Deep link to bill if in URL
                        const params = new URLSearchParams(window.location.search);
                        const billId = params.get('bill');
                        if (billId) {
                            const found = allBills.value.find(b => b.BillNumber === billId);
                            if (found) activeBill.value = found;
                        }
                    } catch (e) {
                        console.error("Load failed", e);
                        allBills.value = [];
                    } finally {
                        loading.value = false;
                    }
                };

                // Optimization: Calculate the master list of agencies once (cached) 
                // instead of re-looping through all bills on every keystroke.
                const allAgencies = computed(() => {
                    const agencies = new Set();
                    allBills.value.forEach(b => {
                        // Safety check: ensure agency_relevance exists
                        b.agency_relevance?.forEach(a => agencies.add(a.agency_name));
                    });
                    return Array.from(agencies).sort();
                });

                // Lightweight filter that runs against the cached list
                const filteredAgencies = computed(() => {
                    const list = allAgencies.value;
                    if (!agencySearch.value) return list;
                    
                    const query = agencySearch.value.toLowerCase();
                    return list.filter(a => a.toLowerCase().includes(query));
                });

                const uniqueBroadSubjects = computed(() => {
                    const map = new Map();
                    allBills.value.forEach(b => {
                        b.BroadSubjects?.forEach(s => map.set(s.Code, s));
                    });
                    return Array.from(map.values()).sort((a,b) => a.Name.localeCompare(b.Name));
                });

                const uniqueNarrowSubjects = computed(() => {
                    const map = new Map();
                    allBills.value.forEach(b => {
                        b.NarrowSubjects?.forEach(s => map.set(s.Code, s));
                    });
                    return Array.from(map.values()).sort((a,b) => a.Name.localeCompare(b.Name));
                });

                const filteredBills = computed(() => {
                    let results = allBills.value;

                    // Agency Filter + Sorting + Rating Filter
                    if (selectedAgency.value) {
                        results = results.filter(b => 
                            b.agency_relevance.some(a => a.agency_name === selectedAgency.value)
                        );

                        // Apply Relevance Rating Filter if not "all"
                        if (filterRating.value !== "all") {
                            results = results.filter(b => {
                                const rel = b.agency_relevance.find(ar => ar.agency_name === selectedAgency.value);
                                return rel && rel.relevance_rating == filterRating.value;
                            });
                        }

                        // Sort by Rating (High to Low)
                        results = [...results].sort((a, b) => {
                            const relA = a.agency_relevance.find(ar => ar.agency_name === selectedAgency.value)?.relevance_rating || 0;
                            const relB = b.agency_relevance.find(ar => ar.agency_name === selectedAgency.value)?.relevance_rating || 0;
                            return relB - relA;
                        });
                    }

                    // Keyword
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        results = results.filter(b => 
                            b.BillNumber.toLowerCase().includes(q) ||
                            (b.CrossfileBillNumber && b.CrossfileBillNumber.toLowerCase().includes(q)) ||
                            b.Title.toLowerCase().includes(q) ||
                            b.bill_summary.toLowerCase().includes(q) ||
                            b.Synopsis.toLowerCase().includes(q)
                        );
                    }

                    // Subjects
                    if (filterBroad.value.length > 0) {
                        results = results.filter(b => 
                            b.BroadSubjects?.some(s => filterBroad.value.includes(s.Name))
                        );
                    }
                    if (filterNarrow.value.length > 0) {
                        results = results.filter(b => 
                            b.NarrowSubjects?.some(s => filterNarrow.value.includes(s.Name))
                        );
                    }

                    return results;
                });

                const selectAgency = (name) => {
                    selectedAgency.value = name;
                    agencySearch.value = name;
                    showAgencyList.value = false;
                    updateUrl();
                };

                const clearAgency = async () => {
                    selectedAgency.value = '';
                    agencySearch.value = '';
                    updateUrl();
                    // Wait for DOM update so the clear button disappears
                    await nextTick(); 
                    const input = document.getElementById('agency-filter-input');
                    if (input) input.focus();
                };

                const getRelevance = (bill) => {
                    if (!selectedAgency.value || !bill.agency_relevance) return null;
                    return bill.agency_relevance.find(a => a.agency_name === selectedAgency.value);
                };

                const openBill = (bill) => {
                    activeBill.value = bill;
                    updateUrl();
                };

                const closeBill = () => {
                    activeBill.value = null;
                    updateUrl();
                };

                const trapFocus = (e) => {
                    const modal = document.querySelector('[role="dialog"]');
                    if (!modal) return;

                    // Get all focusable elements, excluding hidden ones
                    const focusableSelectors = [
                        'button:not([disabled]):not([aria-hidden="true"])',
                        'a[href]:not([aria-hidden="true"])',
                        'input:not([disabled]):not([type="hidden"])',
                        'select:not([disabled])',
                        'textarea:not([disabled])',
                        '[tabindex]:not([tabindex="-1"]):not([aria-hidden="true"])'
                    ].join(', ');
                    
                    const focusableElements = Array.from(modal.querySelectorAll(focusableSelectors))
                        .filter(el => el.offsetParent !== null); // Filter out invisible elements
                    
                    if (focusableElements.length === 0) return;
                    
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];

                    if (e.shiftKey) {
                        // Shift+Tab: if on first element, go to last
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else {
                        // Tab: if on last element, go to first
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                };

                const getNextAction = (bill) => {
                    const now = new Date();
                    const actions = [
                        { label: 'Hearing', date: bill.HearingDateTimePrimaryHouseOfOrigin, isTime: true },
                        { label: 'Hearing', date: bill.HearingDateTimeSecondaryHouseOfOrigin, isTime: true },
                        { label: '2nd Reading', date: bill.SecondReadingDateHouseOfOrigin, isTime: false },
                        { label: '3rd Reading', date: bill.ThirdReadingDateHouseOfOrigin, isTime: false },
                        { label: 'Opposite Hearing', date: bill.HearingDateTimePrimaryOppositeHouse, isTime: true },
                        { label: 'Opposite Hearing', date: bill.HearingDateTimeSecondaryOppositeHouse, isTime: true },
                        { label: 'Opp. 2nd Reading', date: bill.SecondReadingDateOppositeHouse, isTime: false },
                        { label: 'Opp. 3rd Reading', date: bill.ThirdReadingDateOppositeHouse, isTime: false }
                    ];

                    // Filter for valid dates that are today or in the future
                    const upcoming = actions
                        .filter(a => a.date)
                        .map(a => ({ ...a, date: new Date(a.date) }))
                        .filter(a => a.date >= now.setHours(0, 0, 0, 0))
                        .sort((a, b) => a.date - b.date);

                    return upcoming.length > 0 ? upcoming[0] : null;
                };

                const formatCurrency = (val) => {
                    if (val === 0) return "No Direct Fiscal Impact";
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
                };

                const formatDate = (ds) => ds ? new Date(ds).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                const formatTime = (ds) => ds ? new Date(ds).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';

                const exportToExcel = () => {
                    const rows = filteredBills.value.map(b => ({
                        Bill: b.BillNumber,
                        Title: b.Title,
                        MGA_Link: `https://mgaleg.maryland.gov/mgawebsite/Legislation/Details/${b.BillNumber}?ys=${selectedYear.value}RS`,
                        Agency_Rating: getRelevance(b)?.relevance_rating || '',
                        Relevance_Note: getRelevance(b)?.relevance_explanation || '',
                        Summary: b.bill_summary || '',
                        Fiscal_Impact: b.fiscal_impact_summary || '',
                        Funding: (b.funding !== null && b.funding !== undefined) ? b.funding : '',
                        Sponsor: b.SponsorPrimary || '',
                        Status: b.Status || '',
                        Broad_Subjects: b.BroadSubjects?.map(s => s.Name).join('; ') || '',
                        Narrow_Subjects: b.NarrowSubjects?.map(s => s.Name).join('; ') || ''
                    }));

                    if (rows.length === 0) {
                        announceToScreenReader('No bills to export.');
                        return;
                    }
                    
                    const header = Object.keys(rows[0]).join(',');
                    const csv = [header, ...rows.map(row => 
                        Object.values(row).map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')
                    )].join('\n');

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `MD_Legislation_Export_${selectedYear.value}.csv`;
                    link.click();
                    
                    setTimeout(() => URL.revokeObjectURL(link.href), 100);
                    
                    // Announce to screen readers
                    announceToScreenReader(`Export complete. ${rows.length} bills downloaded as CSV.`);
                };

                const focusFirstOption = () => {
                    const firstOption = document.querySelector('#agency-results-list li');
                    if (firstOption) {
                        firstOption.focus();
                    }
                };

                const announceToScreenReader = (message) => {
                    const announcement = document.createElement('div');
                    announcement.setAttribute('role', 'status');
                    announcement.setAttribute('aria-live', 'polite');
                    announcement.setAttribute('aria-atomic', 'true');
                    announcement.className = 'sr-only';
                    announcement.textContent = message;
                    document.body.appendChild(announcement);
                    
                    // Remove after announcement is made
                    setTimeout(() => {
                        document.body.removeChild(announcement);
                    }, 1000);
                };

                onMounted(() => {
                    initFromUrl();
                    fetchData();
                    window.addEventListener('click', handleClickOutside);
                });

                onUnmounted(() => {
                    window.removeEventListener('click', handleClickOutside);
                });

                return {
                    allBills, loading, selectedYear, searchQuery, agencySearch, selectedAgency,
                    showAgencyList, filterBroad, filterNarrow, filterRating, activeBill, showAboutModal,
                    filteredAgencies, uniqueBroadSubjects, uniqueNarrowSubjects, filteredBills,
                    selectAgency, getRelevance, openBill, closeBill, formatCurrency,
                    formatDate, formatTime, exportToExcel, fetchData, getNextAction,
                    modalTitle, trapFocus, clearAgency, clearFilters, agencyFilterContainer,
                    focusFirstOption, announceToScreenReader
                };
            }
        }).mount('#app');
    </script>
</body>
</html>