<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Maryland Legi-Assist | Research & Tracking</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link rel="stylesheet" href="./assets/output_style.css">

</head>
<body class="bg-gray-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 focus:bg-white focus:text-red-800 focus:p-4 focus:font-bold focus:border-2 focus:border-red-800 focus:rounded-lg focus:shadow-xl">
        Skip to main content
    </a>
    <div id="app" v-cloak class="flex flex-col h-full">
        <header class="bg-white shadow-sm z-20 shrink-0">
            <div class="md-flag-strip"></div>
            <div class="max-w-7xl mx-auto px-3 sm:px-4 py-3 sm:py-4">
                <div class="flex flex-col gap-3">
                    <!-- Top row: Logo and actions -->
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2 sm:gap-3">
                            <div>
                                <a href="./" class="hover:opacity-70 transition-opacity">
                                    <h1 class="text-lg sm:text-2xl font-bold text-slate-900 tracking-tight">Maryland Legi-Assist</h1>
                                </a>
                                <div class="flex items-center gap-1">
                                    <p class="text-xs sm:text-sm text-slate-500 uppercase font-bold tracking-widest">AI-assisted Research</p>
                                    <button @click="showAboutModal = true" class="text-slate-400 hover:text-red-800 transition-colors focus:outline-none focus:ring-1 focus:ring-red-800 rounded" aria-label="Learn more about this site's unique features">
                                        <i class="ph ph-question text-base sm:text-lg" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Desktop actions -->
                        <div class="hidden lg:flex items-center gap-3">
                            <button @click="exportToExcel" class="flex items-center gap-2 px-4 py-2 bg-green-700 hover:bg-green-800 text-white rounded-lg transition-colors text-sm font-medium focus:ring-2 focus:ring-offset-2 focus:ring-green-700 outline-none">
                                <i class="ph ph-download-simple" aria-hidden="true"></i> Export
                            </button>
                        </div>

                        <!-- Mobile menu button -->
                        <div class="flex lg:hidden items-center gap-2">
                            <button @click="exportToExcel" class="px-3 py-2 bg-green-700 hover:bg-green-800 text-white rounded-lg min-w-[44px]" aria-label="Export to Excel">
                                <i class="ph ph-download-simple text-lg" aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Search row -->
                    <div class="flex items-center gap-2 sm:gap-3">
                        <!-- Mobile filter toggle -->
                        <button 
                            @click="showFilterDrawer = true"
                            class="lg:hidden flex items-center justify-center gap-2 px-3 py-2 bg-red-800 text-white rounded-lg font-medium text-sm shrink-0"
                            aria-label="Open filters"
                        >
                            <i class="ph ph-funnel text-lg" aria-hidden="true"></i>
                            <span class="hidden sm:inline">Filters</span>
                            <span v-if="activeFilterCount > 0" class="bg-white text-red-800 text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[20px] text-center">{{ activeFilterCount }}</span>
                        </button>

                        <div ref="agencyFilterContainer" class="relative flex-1">
                            <i class="ph ph-buildings absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" aria-hidden="true"></i>
                            <input 
                                v-model="agencySearch" 
                                @focus="showAgencyList = true"
                                @keydown.down.prevent="focusFirstOption"
                                @keydown.escape="showAgencyList = false"
                                type="text" 
                                id="agency-filter-input"
                                role="combobox"
                                aria-autocomplete="list"
                                aria-label="Filter by Agency Relevance"
                                aria-haspopup="listbox"
                                :aria-expanded="showAgencyList && filteredAgencies.length > 0"
                                aria-controls="agency-results-list"
                                placeholder="Filter by Agency..." 
                                class="w-full pl-10 pr-10 py-3 border border-gray-500 placeholder-gray-600 text-slate-900 rounded-lg focus:ring-2 focus:ring-red-800 outline-none font-medium text-sm sm:text-base"
                            >
                            <ul 
                                v-if="showAgencyList && filteredAgencies.length" 
                                id="agency-results-list"
                                role="listbox"
                                aria-label="Agency Search Results"
                                class="absolute left-0 right-0 mt-1 bg-white border border-gray-500 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto list-none p-0"
                            >
                                <li 
                                    v-for="agency in filteredAgencies" 
                                    :key="agency"
                                    @click="selectAgency(agency)"
                                    @keydown.enter="selectAgency(agency)"
                                    @keydown.space.prevent="selectAgency(agency)"
                                    tabindex="0"
                                    role="option"
                                    :aria-selected="agency === selectedAgency"
                                    class="px-4 py-3 hover:bg-red-50 focus:bg-red-50 cursor-pointer text-sm border-b border-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-red-800 text-slate-800"
                                >
                                    {{ agency }}
                                </li>
                            </ul>
                            <button 
                                v-if="selectedAgency" 
                                @click="clearAgency" 
                                aria-label="Clear selected agency"
                                class="absolute right-3 top-1/2 -translate-y-1/2 p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-red-800"
                            >
                                <i class="ph ph-x-circle text-slate-500 hover:text-red-600 text-lg" aria-hidden="true"></i>
                            </button>
                        </div>

                        <select v-model="selectedYear" @change="fetchData" aria-label="Select Legislative Session" class="px-2 sm:px-4 py-2 border border-gray-500 rounded-lg bg-white focus:ring-2 focus:ring-red-800 outline-none font-bold text-sm sm:text-base shrink-0">
                            <option v-for="year in [2026, 2025, 2024, 2023]" :value="year">{{ year }}</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-hidden flex flex-col lg:flex-row">
            <!-- Desktop Sidebar -->
            <aside aria-label="Filter options" class="hidden lg:block w-80 bg-white border-r border-gray-200 overflow-y-auto p-4 space-y-6 shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xs font-black text-gray-500 uppercase tracking-widest">Filters</h2>
                    <button 
                        @click="clearFilters" 
                        class="text-[10px] font-bold text-red-700 hover:text-red-900 uppercase bg-red-50 px-2 py-1 rounded border border-red-100 transition-colors"
                    >
                        Clear All
                    </button>
                </div>
                
                <div role="search">
                    <label for="keyword-search-input-desktop" class="block text-xs font-bold text-gray-500 uppercase mb-2">Keyword Search</label>
                    <div class="relative">
                        <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" aria-hidden="true"></i>
                        <input id="keyword-search-input-desktop" v-model="searchQuery" type="text" class="w-full pl-9 pr-4 py-2 border border-gray-400 rounded-lg text-sm text-slate-900 placeholder-gray-600 focus:ring-2 focus:ring-red-800 outline-none" placeholder="Title, summary, ID...">
                    </div>
                </div>
                
                <div v-if="selectedAgency" class="p-3 bg-red-50 rounded-lg border border-red-100">
                    <label for="impact-rating-filter-desktop" class="block text-[10px] font-black text-red-800 uppercase mb-2 tracking-wider">Filter by Impact Level</label>
                    <select id="impact-rating-filter-desktop" v-model="filterRating" class="w-full bg-white border border-gray-400 rounded px-2 py-1 text-sm text-slate-900 outline-none focus:ring-2 focus:ring-red-800">
                        <option value="all">All Relevance Levels</option>
                        <option value="5">5 - Primary Relevance</option>
                        <option value="4">4 - High Relevance</option>
                        <option value="3">3 - Moderate Relevance</option>
                        <option value="2">2 - Low Relevance</option>
                        <option value="1">1 - Minimal Relevance</option>
                    </select>
                </div>
                
                <fieldset>
                    <legend class="block text-xs font-bold text-gray-500 uppercase mb-2">Broad Subjects</legend>
                    <div class="form-select-multi border border-gray-400 rounded-lg p-2 space-y-1" role="group">
                        <label v-for="sub in uniqueBroadSubjects" :key="sub.Code" class="checkbox-label flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 px-2 py-1 rounded">
                            <input type="checkbox" v-model="filterBroad" :value="sub.Name" class="rounded text-red-800 focus:ring-red-800 w-4 h-4 shrink-0">
                            <span>{{ sub.Name }}</span>
                        </label>
                    </div>
                </fieldset>

                <fieldset>
                    <legend class="block text-xs font-bold text-gray-500 uppercase mb-2">Narrow Subjects</legend>
                    <div class="form-select-multi border border-gray-400 rounded-lg p-2 space-y-1" role="group">
                        <label v-for="sub in uniqueNarrowSubjects" :key="sub.Code" class="checkbox-label flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 px-2 py-1 rounded">
                            <input type="checkbox" v-model="filterNarrow" :value="sub.Name" class="rounded text-red-800 focus:ring-red-800 w-4 h-4 shrink-0">
                            <span>{{ sub.Name }}</span>
                        </label>
                    </div>
                </fieldset>
            </aside>

            <!-- Mobile Filter Drawer -->
            <transition name="fade">
                <div 
                    v-if="showFilterDrawer"
                    class="lg:hidden fixed inset-0 z-50 drawer-overlay"
                    @click.self="showFilterDrawer = false"
                >
                    <aside 
                        ref="filterDrawer"
                        class="absolute left-0 top-0 bottom-0 w-[85vw] max-w-sm bg-white shadow-2xl overflow-y-auto drawer-transition"
                        :class="drawerReady ? 'drawer-open' : 'drawer-enter'"
                        role="dialog"
                        aria-modal="true"
                        aria-label="Filter options"
                        @keydown.esc="showFilterDrawer = false"
                    >
                        <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex items-center justify-between z-10">
                            <h2 class="text-lg font-bold text-slate-900">Filters</h2>
                            <button 
                                @click="showFilterDrawer = false"
                                class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                                aria-label="Close filters"
                            >
                                <i class="ph ph-x text-xl" aria-hidden="true"></i>
                            </button>
                        </div>
                        
                        <div class="p-4 space-y-6">
                            <div class="flex justify-end">
                                <button 
                                    @click="clearFilters" 
                                    class="text-xs font-bold text-red-700 hover:text-red-900 uppercase bg-red-50 px-3 py-2 rounded border border-red-100 transition-colors"
                                >
                                    Clear All Filters
                                </button>
                            </div>
                            
                            <div role="search">
                                <label for="keyword-search-input-mobile" class="block text-xs font-bold text-gray-500 uppercase mb-2">Keyword Search</label>
                                <div class="relative">
                                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" aria-hidden="true"></i>
                                    <input id="keyword-search-input-mobile" v-model="searchQuery" type="text" class="w-full pl-9 pr-4 py-3 border border-gray-400 rounded-lg text-base text-slate-900 placeholder-gray-600 focus:ring-2 focus:ring-red-800 outline-none" placeholder="Title, summary, ID...">
                                </div>
                            </div>
                            
                            <div v-if="selectedAgency" class="p-4 bg-red-50 rounded-lg border border-red-100">
                                <label for="impact-rating-filter-mobile" class="block text-[10px] font-black text-red-800 uppercase mb-2 tracking-wider">Filter by Impact Level</label>
                                <select id="impact-rating-filter-mobile" v-model="filterRating" class="w-full bg-white border border-gray-400 rounded px-3 py-3 text-base text-slate-900 outline-none focus:ring-2 focus:ring-red-800">
                                    <option value="all">All Relevance Levels</option>
                                    <option value="5">5 - Primary Relevance</option>
                                    <option value="4">4 - High Relevance</option>
                                    <option value="3">3 - Moderate Relevance</option>
                                    <option value="2">2 - Low Relevance</option>
                                    <option value="1">1 - Minimal Relevance</option>
                                </select>
                            </div>
                            
                            <fieldset>
                                <legend class="block text-xs font-bold text-gray-500 uppercase mb-2">Broad Subjects</legend>
                                <div class="form-select-multi border border-gray-400 rounded-lg p-2 space-y-0 max-h-48" role="group">
                                    <label v-for="sub in uniqueBroadSubjects" :key="sub.Code" class="checkbox-label flex items-center gap-3 text-sm cursor-pointer hover:bg-gray-50 px-2 rounded">
                                        <input type="checkbox" v-model="filterBroad" :value="sub.Name" class="rounded text-red-800 focus:ring-red-800 w-5 h-5 shrink-0">
                                        <span>{{ sub.Name }}</span>
                                    </label>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend class="block text-xs font-bold text-gray-500 uppercase mb-2">Narrow Subjects</legend>
                                <div class="form-select-multi border border-gray-400 rounded-lg p-2 space-y-0 max-h-48" role="group">
                                    <label v-for="sub in uniqueNarrowSubjects" :key="sub.Code" class="checkbox-label flex items-center gap-3 text-xs cursor-pointer hover:bg-gray-50 px-2 rounded">
                                        <input type="checkbox" v-model="filterNarrow" :value="sub.Name" class="rounded text-red-800 focus:ring-red-800 w-5 h-5 shrink-0">
                                        <span>{{ sub.Name }}</span>
                                    </label>
                                </div>
                            </fieldset>
                        </div>
                        
                        <div class="sticky bottom-0 bg-white border-t border-gray-200 p-4">
                            <button 
                                @click="showFilterDrawer = false"
                                class="w-full py-3 bg-red-800 text-white rounded-lg font-bold text-base hover:bg-red-900 transition-colors"
                            >
                                Show {{ filteredBills.length }} Results
                            </button>
                        </div>
                    </aside>
                </div>
            </transition>

            <section class="flex-1 overflow-y-auto bg-gray-50 p-3 sm:p-4 relative">
                <div v-if="loading" role="status" aria-live="polite" class="absolute inset-0 z-10 bg-white/80 flex items-center justify-center flex-col">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-red-800 mb-4"></div>
                    <p class="font-medium text-slate-600">Syncing Legislative Data...</p>
                </div>

                <div class="max-w-5xl mx-auto">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <div role="status" aria-live="polite" aria-atomic="true" class="sr-only">
                            <template v-if="loading">Loading bills...</template>
                            <template v-else>
                                {{ filteredBills.length }} bills match your search criteria<template v-if="selectedAgency"> for {{ selectedAgency }}</template>.
                            </template>
                        </div>
                        <h2 class="text-base sm:text-xl font-bold text-slate-800" aria-hidden="true">
                            {{ filteredBills.length }} Bills
                            <span v-if="selectedAgency" class="text-red-800 block sm:inline text-sm sm:text-xl">for {{ selectedAgency }}</span>
                        </h2>
                    </div>

                    <div class="space-y-3 sm:space-y-4">
                        <article 
                            v-for="bill in filteredBills" 
                            :key="bill.BillNumber"
                            class="bg-white rounded-xl border border-gray-200 shadow-sm hover:border-red-300 transition-all group focus-within:ring-2 focus-within:ring-red-800 focus-within:border-red-800"
                        >
                            <button
                                @click="openBill(bill)"
                                class="w-full text-left p-4 sm:p-5 focus:outline-none"
                                :aria-label="'View details for bill ' + bill.BillNumber + ': ' + bill.Title"
                            >
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2 sm:gap-4">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-1">
                                            <span class="text-base sm:text-lg font-black text-red-800 group-hover:underline">
                                                {{ bill.BillNumber }}{{ bill.CrossfileBillNumber ? '/' + bill.CrossfileBillNumber : '' }}
                                            </span>
                                            <span v-if="getRelevance(bill)" class="px-2 py-0.5 bg-amber-100 text-amber-800 text-xs font-bold rounded">
                                                {{ getRelevance(bill).relevance_rating }}/5
                                            </span>
                                        </div>
                                        <h3 class="font-bold text-slate-900 leading-tight mb-2 text-sm sm:text-base">{{ bill.Title }}</h3>
                                        <p class="text-xs sm:text-sm text-slate-600 line-clamp-2">{{ bill.bill_summary }}</p>
                                    </div>

                                    <div v-if="selectedYear === 2026 && getNextAction(bill)" class="text-left sm:text-right shrink-0 pt-2 sm:pt-0 border-t sm:border-t-0 border-gray-100">
                                        <div class="text-[10px] font-bold text-red-700 uppercase tracking-tighter">{{ getNextAction(bill).label }}</div>
                                        <div class="text-sm font-bold text-slate-700">{{ formatDate(getNextAction(bill).date) }}</div>
                                        <div v-if="getNextAction(bill).isTime" class="text-xs text-slate-500">{{ formatTime(getNextAction(bill).date) }}</div>
                                    </div>
                                </div>
                            </button>
                        </article>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bill Detail Modal -->
        <transition name="fade">
            <div 
                v-if="activeBill" 
                role="dialog" 
                aria-modal="true" 
                aria-labelledby="modal-title"
                class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4 bg-slate-900/60 backdrop-blur-sm" 
                @click.self="closeBill"
                @keydown.esc="closeBill"
                @keydown.tab="trapFocus"
            >
                <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl w-full sm:max-w-5xl max-h-[95vh] sm:max-h-[90vh] flex flex-col overflow-hidden">
                    <header class="p-4 sm:p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-start gap-3 shrink-0 pt-[max(1rem,env(safe-area-inset-top))]">
                        <div class="min-w-0 flex-1">
                            <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-1">
                                <h2 id="modal-title" ref="modalTitle" tabindex="-1" class="text-xl sm:text-3xl font-black text-red-900 outline-none">
                                    {{ activeBill.BillNumber }}{{ activeBill.CrossfileBillNumber ? '/' + activeBill.CrossfileBillNumber : '' }}
                                </h2>
                                <span class="px-2 sm:px-3 py-1 bg-white border border-gray-200 rounded-full text-[10px] sm:text-xs font-bold text-slate-500">{{ activeBill.YearAndSession }}</span>
                            </div>
                            <h3 class="text-sm sm:text-lg font-bold text-slate-800 line-clamp-2 sm:line-clamp-none">{{ activeBill.Title }}</h3>
                        </div>
                        <button @click="closeBill" aria-label="Close Modal" class="p-2 hover:bg-gray-200 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-red-800 shrink-0">
                            <i class="ph ph-x text-xl sm:text-2xl" aria-hidden="true"></i>
                        </button>
                    </header>

                    <div class="flex-1 overflow-y-auto p-4 sm:p-6 md:p-10">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-10">
                            <div class="lg:col-span-2 space-y-6 sm:space-y-8">
                                <section v-if="getRelevance(activeBill)" aria-labelledby="relevance-heading" class="bg-red-50 border-l-4 border-red-800 p-4 sm:p-6 rounded-r-xl">
                                    <h4 id="relevance-heading" class="text-red-900 font-bold uppercase text-xs tracking-widest mb-2">Agency Relevance: {{ selectedAgency }}</h4>
                                    <p class="text-slate-800 font-medium leading-relaxed text-sm sm:text-base">{{ getRelevance(activeBill).relevance_explanation }}</p>
                                </section>

                                <section aria-labelledby="summary-heading">
                                    <h4 id="summary-heading" class="text-slate-600 font-bold uppercase text-xs tracking-widest mb-3">Plain-English Summary</h4>
                                    <p class="text-slate-700 leading-relaxed text-base sm:text-lg">{{ activeBill.bill_summary }}</p>
                                </section>

                                <section aria-labelledby="fiscal-heading">
                                    <h4 id="fiscal-heading" class="text-slate-600 font-bold uppercase text-xs tracking-widest mb-3">Fiscal Impact Analysis</h4>
                                    <div class="bg-emerald-50 text-emerald-900 p-4 sm:p-5 rounded-xl border border-emerald-100 text-sm sm:text-base">
                                        {{ activeBill.fiscal_impact_summary }}
                                    </div>
                                </section>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <h5 class="text-xs font-bold text-slate-600 uppercase mb-2">Responsible Party</h5>
                                        <p class="font-bold text-slate-800 text-sm sm:text-base">{{ activeBill.responsible_party || 'N/A' }}</p>
                                    </div>
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <h5 class="text-xs font-bold text-slate-600 uppercase mb-2">Stakeholders</h5>
                                        <p class="text-xs sm:text-sm text-slate-700">{{ activeBill.stakeholders }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <dl class="bg-slate-50 rounded-xl p-4 sm:p-5 space-y-4">
                                    <div>
                                        <dt class="text-[10px] font-bold text-slate-600 uppercase">Primary Sponsor</dt>
                                        <dd class="font-bold text-slate-900 text-sm sm:text-base">{{ activeBill.SponsorPrimary }}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-[10px] font-bold text-slate-600 uppercase">Current Status</dt>
                                        <dd class="text-xs sm:text-sm font-medium text-red-800">{{ activeBill.Status }}</dd>
                                    </div>
                                    <div v-if="activeBill.funding !== null">
                                        <dt class="text-[10px] font-bold text-slate-600 uppercase">Est. Funding Impact</dt>
                                        <dd class="text-base sm:text-lg font-black text-emerald-700">{{ formatCurrency(activeBill.funding) }}</dd>
                                    </div>
                                </dl>

                                <div>
                                    <h4 class="text-xs font-bold text-slate-600 uppercase mb-2">Subjects</h4>
                                    <ul class="flex flex-wrap gap-2" aria-label="Bill subjects">
                                        <li v-for="s in activeBill.BroadSubjects" class="px-2 py-1 bg-slate-200 text-slate-700 rounded text-[10px] font-bold uppercase">{{ s.Name }}</li>
                                        <li v-for="s in activeBill.NarrowSubjects" class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-[10px]">{{ s.Name }}</li>
                                    </ul>
                                </div>

                                <a :href="'https://mgaleg.maryland.gov/mgawebsite/Legislation/Details/' + activeBill.BillNumber + '?ys=' + selectedYear + 'RS'" 
                                target="_blank"
                                rel="noopener"
                                class="flex items-center justify-center gap-2 w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-black transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-slate-900 text-sm sm:text-base">
                                    View Bill on MGA
                                    <i class="ph ph-arrow-square-out" aria-hidden="true"></i>
                                    <span class="sr-only">(opens in new tab)</span>
                                </a>
                            </div>
                        </div>

                        <div class="mt-6 sm:mt-10 pt-4 sm:pt-6 border-t border-gray-100">
                            <div class="flex flex-col sm:flex-row gap-3 items-start bg-slate-50 p-4 rounded-xl border border-slate-200 text-slate-600">
                                <i class="ph ph-robot text-xl shrink-0 mt-0.5 text-slate-400" aria-hidden="true"></i>
                                <div class="text-xs font-medium leading-relaxed">
                                    <strong class="block mb-1 text-slate-700 uppercase tracking-wide">Automated Summary Disclaimer</strong>
                                    <p>
                                        The summary content, relevance ratings, and fiscal analysis displayed here were generated using AI and may contain inaccuracies. 
                                        This tool is for research assistance only. Please verify all details directly against the official 
                                        <a :href="'https://mgaleg.maryland.gov/mgawebsite/Legislation/Details/' + activeBill.BillNumber + '?ys=' + selectedYear + 'RS'" target="_blank" rel="noopener" class="underline hover:text-red-800 text-slate-900 font-bold decoration-slate-400 underline-offset-2">
                                            Maryland General Assembly website
                                            <span class="sr-only">(opens in new tab)</span>
                                        </a>.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- About Modal -->
        <transition name="fade">
            <div 
                v-if="showAboutModal" 
                role="dialog" 
                aria-modal="true" 
                aria-labelledby="about-modal-title"
                class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4 bg-slate-900/60 backdrop-blur-sm" 
                @click.self="showAboutModal = false"
                @keydown.esc="showAboutModal = false"
                @keydown.tab="trapFocus"
            >
                <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl w-full sm:max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
                    <header class="p-4 sm:p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center shrink-0 pt-[max(1rem,env(safe-area-inset-top))]">
                        <h2 id="about-modal-title" ref="modalTitle" tabindex="-1" class="text-lg sm:text-xl font-bold text-slate-900 outline-none">
                            About Maryland Legi-Assist
                        </h2>
                        <button @click="showAboutModal = false" aria-label="Close Modal" class="p-2 hover:bg-gray-200 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-red-800">
                            <i class="ph ph-x text-xl" aria-hidden="true"></i>
                        </button>
                    </header>
                    <div class="p-6 sm:p-8 space-y-6 overflow-y-auto">
                        <section class="flex gap-3 sm:gap-4">
                            <div class="bg-red-50 p-2 sm:p-3 rounded-lg h-fit text-red-800 shrink-0">
                                <i class="ph ph-file-text text-xl sm:text-2xl" aria-hidden="true"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-900 mb-1 text-sm sm:text-base">LLM-Friendly Conversion</h3>
                                <p class="text-slate-600 text-xs sm:text-sm leading-relaxed">
                                    Unlike standard PDF tools, our custom conversion process identifies and preserves 
                                    <span class="font-mono bg-gray-100 px-1 rounded text-red-700">~stricken~</span> 
                                    language.
                                </p>
                            </div>
                        </section>

                        <section class="flex gap-3 sm:gap-4">
                            <div class="bg-blue-50 p-2 sm:p-3 rounded-lg h-fit text-blue-800 shrink-0">
                                <i class="ph ph-git-merge text-xl sm:text-2xl" aria-hidden="true"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-900 mb-1 text-sm sm:text-base">Real-time Amendment Previews</h3>
                                <p class="text-slate-600 text-xs sm:text-sm leading-relaxed">
                                    We use AI to programmatically apply adopted amendments to the base bill text, providing an "early enrolled" preview.
                                </p>
                            </div>
                        </section>

                        <section class="flex gap-3 sm:gap-4">
                            <div class="bg-emerald-50 p-2 sm:p-3 rounded-lg h-fit text-emerald-800 shrink-0">
                                <i class="ph ph-sparkle text-xl sm:text-2xl" aria-hidden="true"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-900 mb-1 text-sm sm:text-base">AI-Generated Summaries & Ratings</h3>
                                <p class="text-slate-600 text-xs sm:text-sm leading-relaxed">
                                    Every bill is enhanced with plain-English summaries, fiscal impact extractions, and relevance ratings.
                                </p>
                            </div>
                        </section>
                    </div>
                    <footer class="p-4 sm:p-6 bg-slate-50 border-t border-gray-100 flex justify-between items-center shrink-0">
                        <a href="https://github.com/Maryland-State-Innovation-Team/Legi-Assist/" target="_blank" rel="noopener" class="flex items-center gap-2 text-slate-600 hover:text-slate-900 transition-colors text-sm font-medium">
                            <i class="ph ph-github-logo text-lg" aria-hidden="true"></i> View on GitHub
                            <span class="sr-only">(opens in new tab)</span>
                        </a>
                        <button @click="showAboutModal = false" class="px-6 py-3 bg-slate-900 text-white rounded-lg font-bold hover:bg-black transition-colors">
                            Got it
                        </button>
                    </footer>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const allBills = ref([]);
                const loading = ref(true);
                const selectedYear = ref(2026);
                const searchQuery = ref("");
                const agencySearch = ref("");
                const selectedAgency = ref("");
                const showAgencyList = ref(false);
                const filterBroad = ref([]);
                const filterNarrow = ref([]);
                const filterRating = ref("all");
                const activeBill = ref(null);
                const showAboutModal = ref(false);
                const showFilterDrawer = ref(false);
                const drawerReady = ref(false);
                const modalTitle = ref(null);
                const agencyFilterContainer = ref(null);
                const filterDrawer = ref(null);
                let lastActiveElement = null;

                // Count active filters for badge
                const activeFilterCount = computed(() => {
                    let count = 0;
                    if (searchQuery.value) count++;
                    if (filterRating.value !== 'all') count++;
                    count += filterBroad.value.length;
                    count += filterNarrow.value.length;
                    return count;
                });

                // Handle drawer animation
                watch(showFilterDrawer, async (val) => {
                    if (val) {
                        drawerReady.value = false;
                        lastActiveElement = document.activeElement;
                        await nextTick();
                        requestAnimationFrame(() => {
                            drawerReady.value = true;
                        });
                        // Focus first focusable element in drawer
                        await nextTick();
                        const firstInput = filterDrawer.value?.querySelector('input, button, select');
                        if (firstInput) firstInput.focus();
                    } else {
                        drawerReady.value = false;
                        await nextTick();
                        if (lastActiveElement && document.body.contains(lastActiveElement)) {
                            lastActiveElement.focus();
                        }
                    }
                });

                // A11y: Manage Focus for modals
                watch([activeBill, showAboutModal], async ([newBill, newAbout]) => {
                    if (newBill || newAbout) {
                        lastActiveElement = document.activeElement;
                        await nextTick();
                        const modal = document.querySelector('[role="dialog"]');
                        if (modal) {
                            const closeBtn = modal.querySelector('button[aria-label="Close Modal"]');
                            if (closeBtn) closeBtn.focus();
                        }
                    } else {
                        await nextTick();
                        if (lastActiveElement && document.body.contains(lastActiveElement)) {
                            lastActiveElement.focus();
                        }
                    }
                });

                const handleClickOutside = (event) => {
                    if (agencyFilterContainer.value && !agencyFilterContainer.value.contains(event.target)) {
                        showAgencyList.value = false;
                    }
                };

                const clearFilters = () => {
                    searchQuery.value = "";
                    agencySearch.value = "";
                    selectedAgency.value = "";
                    filterBroad.value = [];
                    filterNarrow.value = [];
                    filterRating.value = "all";
                    updateUrl();
                };

                watch([searchQuery, filterBroad, filterNarrow], () => { updateUrl(); });

                const initFromUrl = () => {
                    const params = new URLSearchParams(window.location.search);
                    if (params.get('year')) selectedYear.value = parseInt(params.get('year'));
                    if (params.get('agency')) {
                        selectedAgency.value = params.get('agency');
                        agencySearch.value = params.get('agency');
                    }
                    if (params.get('q')) searchQuery.value = params.get('q');
                    const broad = params.getAll('broad');
                    if (broad.length > 0) filterBroad.value = broad;
                    const narrow = params.getAll('narrow');
                    if (narrow.length > 0) filterNarrow.value = narrow;
                };

                const updateUrl = () => {
                    const params = new URLSearchParams();
                    params.set('year', selectedYear.value);
                    if (selectedAgency.value) params.set('agency', selectedAgency.value);
                    if (activeBill.value) params.set('bill', activeBill.value.BillNumber);
                    if (searchQuery.value) params.set('q', searchQuery.value);
                    filterBroad.value.forEach(val => params.append('broad', val));
                    filterNarrow.value.forEach(val => params.append('narrow', val));
                    const newUrl = `${window.location.pathname}?${params.toString()}`;
                    window.history.replaceState({}, '', newUrl);
                    notifyParentOfUrlChange();
                };

                const notifyParentOfUrlChange = () => {
                    if (window.parent !== window) {
                        try {
                            const targetOrigin = window.location.hostname === 'localhost'
                                ? '*'
                                : 'https://ai.maryland.gov';
                            window.parent.postMessage({
                                type: 'legiassist-url-change',
                                params: window.location.search,
                                title: document.title
                            }, targetOrigin);
                        } catch (e) {
                            // Silently fail if postMessage blocked
                        }
                    }
                };

                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const resp = await fetch(`data/${selectedYear.value}rs/frontend_data.json`);
                        const data = await resp.json();
                        allBills.value = data.filter(b => b.agency_relevance && b.agency_relevance.length > 0);
                        const params = new URLSearchParams(window.location.search);
                        const billId = params.get('bill');
                        if (billId) {
                            const found = allBills.value.find(b => b.BillNumber === billId);
                            if (found) activeBill.value = found;
                        }
                    } catch (e) {
                        console.error("Load failed", e);
                        allBills.value = [];
                    } finally {
                        loading.value = false;
                    }
                };

                const allAgencies = computed(() => {
                    const agencies = new Set();
                    allBills.value.forEach(b => {
                        b.agency_relevance?.forEach(a => agencies.add(a.agency_name));
                    });
                    return Array.from(agencies).sort();
                });

                const filteredAgencies = computed(() => {
                    const list = allAgencies.value;
                    if (!agencySearch.value) return list;
                    const query = agencySearch.value.toLowerCase();
                    return list.filter(a => a.toLowerCase().includes(query));
                });

                const uniqueBroadSubjects = computed(() => {
                    const map = new Map();
                    allBills.value.forEach(b => {
                        b.BroadSubjects?.forEach(s => map.set(s.Code, s));
                    });
                    return Array.from(map.values()).sort((a,b) => a.Name.localeCompare(b.Name));
                });

                const uniqueNarrowSubjects = computed(() => {
                    const map = new Map();
                    allBills.value.forEach(b => {
                        b.NarrowSubjects?.forEach(s => map.set(s.Code, s));
                    });
                    return Array.from(map.values()).sort((a,b) => a.Name.localeCompare(b.Name));
                });

                const filteredBills = computed(() => {
                    let results = allBills.value;
                    if (selectedAgency.value) {
                        results = results.filter(b => 
                            b.agency_relevance.some(a => a.agency_name === selectedAgency.value)
                        );
                        if (filterRating.value !== "all") {
                            results = results.filter(b => {
                                const rel = b.agency_relevance.find(ar => ar.agency_name === selectedAgency.value);
                                return rel && rel.relevance_rating == filterRating.value;
                            });
                        }
                        results = [...results].sort((a, b) => {
                            const relA = a.agency_relevance.find(ar => ar.agency_name === selectedAgency.value)?.relevance_rating || 0;
                            const relB = b.agency_relevance.find(ar => ar.agency_name === selectedAgency.value)?.relevance_rating || 0;
                            return relB - relA;
                        });
                    }
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        results = results.filter(b => 
                            b.BillNumber.toLowerCase().includes(q) ||
                            (b.CrossfileBillNumber && b.CrossfileBillNumber.toLowerCase().includes(q)) ||
                            b.Title.toLowerCase().includes(q) ||
                            b.bill_summary.toLowerCase().includes(q) ||
                            b.Synopsis.toLowerCase().includes(q)
                        );
                    }
                    if (filterBroad.value.length > 0) {
                        results = results.filter(b => 
                            b.BroadSubjects?.some(s => filterBroad.value.includes(s.Name))
                        );
                    }
                    if (filterNarrow.value.length > 0) {
                        results = results.filter(b => 
                            b.NarrowSubjects?.some(s => filterNarrow.value.includes(s.Name))
                        );
                    }
                    return results;
                });

                const selectAgency = (name) => {
                    selectedAgency.value = name;
                    agencySearch.value = name;
                    showAgencyList.value = false;
                    updateUrl();
                };

                const clearAgency = async () => {
                    selectedAgency.value = '';
                    agencySearch.value = '';
                    updateUrl();
                    await nextTick(); 
                    const input = document.getElementById('agency-filter-input');
                    if (input) input.focus();
                };

                const getRelevance = (bill) => {
                    if (!selectedAgency.value || !bill.agency_relevance) return null;
                    return bill.agency_relevance.find(a => a.agency_name === selectedAgency.value);
                };

                const openBill = (bill) => {
                    activeBill.value = bill;
                    updateUrl();
                };

                const closeBill = () => {
                    activeBill.value = null;
                    updateUrl();
                };

                const trapFocus = (e) => {
                    const modal = document.querySelector('[role="dialog"]');
                    if (!modal) return;
                    const focusableSelectors = [
                        'button:not([disabled]):not([aria-hidden="true"])',
                        'a[href]:not([aria-hidden="true"])',
                        'input:not([disabled]):not([type="hidden"])',
                        'select:not([disabled])',
                        'textarea:not([disabled])',
                        '[tabindex]:not([tabindex="-1"]):not([aria-hidden="true"])'
                    ].join(', ');
                    const focusableElements = Array.from(modal.querySelectorAll(focusableSelectors))
                        .filter(el => el.offsetParent !== null);
                    if (focusableElements.length === 0) return;
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                };

                const getNextAction = (bill) => {
                    const now = new Date();
                    const actions = [
                        { label: 'Hearing', date: bill.HearingDateTimePrimaryHouseOfOrigin, isTime: true },
                        { label: 'Hearing', date: bill.HearingDateTimeSecondaryHouseOfOrigin, isTime: true },
                        { label: '2nd Reading', date: bill.SecondReadingDateHouseOfOrigin, isTime: false },
                        { label: '3rd Reading', date: bill.ThirdReadingDateHouseOfOrigin, isTime: false },
                        { label: 'Opp. Hearing', date: bill.HearingDateTimePrimaryOppositeHouse, isTime: true },
                        { label: 'Opp. Hearing', date: bill.HearingDateTimeSecondaryOppositeHouse, isTime: true },
                        { label: 'Opp. 2nd', date: bill.SecondReadingDateOppositeHouse, isTime: false },
                        { label: 'Opp. 3rd', date: bill.ThirdReadingDateOppositeHouse, isTime: false }
                    ];
                    const upcoming = actions
                        .filter(a => a.date)
                        .map(a => ({ ...a, date: new Date(a.date) }))
                        .filter(a => a.date >= now.setHours(0, 0, 0, 0))
                        .sort((a, b) => a.date - b.date);
                    return upcoming.length > 0 ? upcoming[0] : null;
                };

                const formatCurrency = (val) => {
                    if (val === 0) return "No Direct Fiscal Impact";
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
                };

                const formatDate = (ds) => ds ? new Date(ds).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                const formatTime = (ds) => ds ? new Date(ds).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';

                const exportToExcel = () => {
                    const rows = filteredBills.value.map(b => ({
                        Bill: b.BillNumber,
                        Title: b.Title,
                        MGA_Link: `https://mgaleg.maryland.gov/mgawebsite/Legislation/Details/${b.BillNumber}?ys=${selectedYear.value}RS`,
                        Agency_Rating: getRelevance(b)?.relevance_rating || '',
                        Relevance_Note: getRelevance(b)?.relevance_explanation || '',
                        Summary: b.bill_summary || '',
                        Fiscal_Impact: b.fiscal_impact_summary || '',
                        Funding: (b.funding !== null && b.funding !== undefined) ? b.funding : '',
                        Sponsor: b.SponsorPrimary || '',
                        Status: b.Status || '',
                        Broad_Subjects: b.BroadSubjects?.map(s => s.Name).join('; ') || '',
                        Narrow_Subjects: b.NarrowSubjects?.map(s => s.Name).join('; ') || ''
                    }));
                    if (rows.length === 0) {
                        announceToScreenReader('No bills to export.');
                        return;
                    }
                    const header = Object.keys(rows[0]).join(',');
                    const csv = [header, ...rows.map(row => 
                        Object.values(row).map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')
                    )].join('\n');
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `MD_Legislation_Export_${selectedYear.value}.csv`;
                    link.click();
                    setTimeout(() => URL.revokeObjectURL(link.href), 100);
                    announceToScreenReader(`Export complete. ${rows.length} bills downloaded as CSV.`);
                };

                const focusFirstOption = () => {
                    const firstOption = document.querySelector('#agency-results-list li');
                    if (firstOption) firstOption.focus();
                };

                const announceToScreenReader = (message) => {
                    const announcement = document.createElement('div');
                    announcement.setAttribute('role', 'status');
                    announcement.setAttribute('aria-live', 'polite');
                    announcement.setAttribute('aria-atomic', 'true');
                    announcement.className = 'sr-only';
                    announcement.textContent = message;
                    document.body.appendChild(announcement);
                    setTimeout(() => { document.body.removeChild(announcement); }, 1000);
                };

                onMounted(() => {
                    initFromUrl();
                    fetchData();
                    window.addEventListener('click', handleClickOutside);
                    // Listen for URL state from parent
                    window.addEventListener('message', (event) => {
                        const allowedOrigins = [
                            'https://ai.maryland.gov',
                            'http://localhost:8000'
                        ];
                        if (!allowedOrigins.includes(event.origin)) return;
                        
                        if (event.data.type === 'legiassist-set-params') {
                            const params = new URLSearchParams(event.data.params);
                            if (params.get('year')) selectedYear.value = parseInt(params.get('year'));
                            if (params.get('agency')) {
                                selectedAgency.value = params.get('agency');
                                agencySearch.value = params.get('agency');
                            }
                            if (params.get('q')) searchQuery.value = params.get('q');
                            fetchData();
                            updateUrl();
                        }
                    });
                });

                onUnmounted(() => {
                    window.removeEventListener('click', handleClickOutside);
                });

                return {
                    allBills, loading, selectedYear, searchQuery, agencySearch, selectedAgency,
                    showAgencyList, filterBroad, filterNarrow, filterRating, activeBill, showAboutModal,
                    showFilterDrawer, drawerReady, activeFilterCount,
                    filteredAgencies, uniqueBroadSubjects, uniqueNarrowSubjects, filteredBills,
                    selectAgency, getRelevance, openBill, closeBill, formatCurrency,
                    formatDate, formatTime, exportToExcel, fetchData, getNextAction,
                    modalTitle, trapFocus, clearAgency, clearFilters, agencyFilterContainer,
                    filterDrawer, focusFirstOption, announceToScreenReader
                };
            }
        }).mount('#app');
    </script>
</body>
</html>